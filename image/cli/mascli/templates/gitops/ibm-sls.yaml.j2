---
# IBM Suite License Service
apiVersion: argoproj.io/v1alpha1
kind: Application
metadata:
  name: mas-{{ MAS_INSTANCE_ID }}-sls
  namespace: openshift-gitops
  finalizers:
    - resources-finalizer.argocd.argoproj.io
spec:
  project: {{ MAS_INSTANCE_ID }}
  destination:
    server: https://kubernetes.default.svc
    namespace: mas-{{ MAS_INSTANCE_ID }}-sls
  source:
    repoURL: https://github.com/ibm-mas/gitops
    path: applications/ibm-sls
    targetRevision: {{ GITOPS_VERSION }}
    plugin:
      env:
        - name: HELM_VALUES
          value: |
            mas_instance_id: {{ MAS_INSTANCE_ID }}
            sls_channel: {{ SLS_CHANNEL }}
            sls_entitlement_file: <path:{{ SECRETS_PATH }}:{{ SECRET_KEY_LICENSE_FILE }}>
            ibm_entitlement_key: <path:{{ SECRETS_PATH }}:{{ SECRET_KEY_IBM_ENTITLEMENT }}>
            sls_mongo_username: <path:{{ SECRETS_PATH }}:{{ SECRET_KEY_MONGO_USERNAME }}>
            sls_mongo_password: <path:{{ SECRETS_PATH }}:{{ SECRET_KEY_MONGO_PASSWORD }}>
            sls_mongo_secret_name: sls-mongo-credentials
            mongo_spec:
              authMechanism: DEFAULT
              configDb: admin
              secretName: sls-mongo-credentials
              {% if config.retryWrites is sameas false %}
              retryWrites: false
              {% endif %}
              nodes:
                {% for mongo_host in config.hosts -%}
                - host: {{ mongo_host.host }}
                  port: {{ mongo_host.port }}
                {% endfor %}
              certificates:
                {% if config.certificate -%}
                {% for mongo_certificate in config.certificate -%}
                - alias: {{ mongo_certificate.alias }}
                  crt: |
                    {% filter indent(width=20) -%}
                    {{ mongo_certificate.crt }}
                    {%- endfilter %}
                {% endfor %}
                {% elif certificates -%}
                {% for mongo_certificate in certificates -%}
                - alias: {{ mongo_certificate.alias }}
                  crt: |
                    {% filter indent(width=20) -%}
                    {{ mongo_certificate.crt }}
                    {%- endfilter %}
                {% endfor %}
                {% endif %}
  syncPolicy:
    automated:
      prune: true
      selfHeal: true
    syncOptions:
      - CreateNamespace=false
    managedNamespaceMetadata:
      labels:
        argocd.argoproj.io/managed-by: openshift-gitops
