- name: Generate Tekton Pipelines
  hosts: localhost
  any_errors_fatal: true
  vars:
    mas_tekton_version: latest

    params_src_dir: src/params
    params_tmp_dir: tmp

    pipeline_src_dir: src/pipelines
    pipeline_target_dir: target/pipelines
  tasks:

    # 1. Prepare tmp and target directory for the pipeline build
    # -------------------------------------------------------------------------
    - name: Create target directory
      ansible.builtin.file:
        path: "{{ pipeline_target_dir }}"
        state: directory

    # 2. Generate Pipelines
    # -------------------------------------------------------------------------
    - name: Generate Pipelines
      vars:
        wait_for_install: false
      ansible.builtin.template:
        src: "{{ pipeline_src_dir }}/{{ item }}.yml.j2"
        dest: "{{ pipeline_target_dir }}/{{ item }}.yaml"
      with_items:
        - db2
        - install
        - install-with-fvt
        - fvt-assist
        - fvt-core
        - fvt-deprovision-after
        - fvt-manage-regr
        - update
        - upgrade
        - uninstall

    # 2. Generate Pipelines
    # -------------------------------------------------------------------------
    - name: Generate Pipelines (wait-for-install versions)
      vars:
        wait_for_install: true
      ansible.builtin.template:
        src: "{{ pipeline_src_dir }}/{{ item }}.yml.j2"
        dest: "{{ pipeline_target_dir }}/{{ item }}-after-install.yaml"
      with_items:
        - update
        - upgrade
        - uninstall

    # 3. Generate Gitops Pipelines
    # -------------------------------------------------------------------------
    - name: Generate GitOps Pipelines 
      vars:
        wait_for_provsion: false
        wait_for_deprovsion: false
      ansible.builtin.template:
        src: "{{ pipeline_src_dir }}/gitops/{{ item }}.yml.j2"
        dest: "{{ pipeline_target_dir }}/gitops/{{ item }}.yaml"
      with_items:
        - deprovision-cluster
        - deprovision-mas-instance
        - provision-bootstrap-cluster
        - provision-mas-instance

    # 4. Generate Gitops Pipelines with waits
    # -------------------------------------------------------------------------
    - name: Generate GitOps Pipelines with wait-after-provision
      vars:
        wait_for_deprovision: true
      ansible.builtin.template:
        src: "{{ pipeline_src_dir }}/gitops/{{ item }}.yml.j2"
        dest: "{{ pipeline_target_dir }}/gitops/{{ item }}-after-deprovision.yaml"
      with_items:
        - provision-bootstrap-cluster

    # 5. Generate Gitops Pipelines with waits
    # -------------------------------------------------------------------------
    - name: Generate GitOps Pipelines with wait-after-provision
      vars:
        wait_for_provision: true
      ansible.builtin.template:
        src: "{{ pipeline_src_dir }}/gitops/{{ item }}.yml.j2"
        dest: "{{ pipeline_target_dir }}/gitops/{{ item }}-after-provision.yaml"
      with_items:
        - provision-mas-instance