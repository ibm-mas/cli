---
apiVersion: tekton.dev/v1beta1
kind: Task
metadata:
  name: mas-fvt-run-pipeline
spec:
  params:    
    # Pipeline Run Parameters
    - name: pipelinerun_template_file_name
      type: string
      description: name of the pipelinerun template (.yml.j2)
      default: fvt
    - name: pipelinerun_timeout
      type: string
      description: pipelinerun timeout
      default: 10h
    
    # Other Parameters (MAS and Devops)
    - name: mas_instance_id            # Required
      type: string
    - name: mas_channel                # Required
      type: string
    - name: mas_workspace_id
      type: string
      description: Workspace ID used to configure all applications
      default: masdev
    - name: devops_mongo_uri
      type: string
      default: ""
    - name: devops_build_number
      type: string
      default: ""
    - name: ibm_entitlement_key
      type: string
      default: ""
    - name: sls_license_id
      type: string
      default: ""
    - name: sls_license_file
      type: string
      default: ""
    - name: cpd_product_version
      type: string
      default: ""
    - name: uds_contact_email
      type: string
      default: ""
    - name: uds_contact_firstname
      type: string
      default: ""
    - name: uds_contact_lastname
      type: string
      default: ""
    - name: cos_type
      type: string
      default: ""
    - name: ibmcloud_apikey
      type: string
      default: ""

    # Test Parameters
    {{ lookup('template', 'pipelines/params/fvt.yml.j2') | indent(4) }}

  stepTemplate:
    name: 'run-pipeline-$(params.pipeline_name)'
    env:
      - name: PIPELINERUN_TEMPLATE_FILE_NAME
        value: $(params.pipelinerun_template_file_name)
      - name: PIPELINERUN_TIMEOUT
        value: $(params.pipelinerun_timeout)
      - name: PIPELINERUN_WAIT
        value: "true"

      - name: DEVOPS_MONGO_URI
        value: $(params.devops_mongo_uri)
      - name: DEVOPS_BUILD_NUMBER
        value: $(params.devops_build_number)
      - name: MAS_INSTANCE_ID
        value: $(params.mas_instance_id)
      - name: MAS_CHANNEL
        value: $(params.mas_channel)
      - name: MAS_WORKSPACE_ID
        value: $(params.mas_workspace_id)

      - name: IBM_ENTITLEMENT_KEY
        value: $(params.ibm_entitlement_key)
      - name: SLS_LICENSE_ID
        value: $(params.sls_license_id)
      - name: SLS_LICENSE_FILE
        value: $(params.sls_license_file)
      - name: CPD_PRODUCT_VERSION
        value: $(params.cpd_product_version)
      - name: UDS_CONTACT_EMAIL
        value: $(params.uds_contact_email)
      - name: UDS_CONTACT_FIRSTNAME
        value: $(params.uds_contact_firstname)
      - name: UDS_CONTACT_LASTNAME
        value: $(params.uds_contact_lastname)
      - name: COS_TYPE
        value: $(params.cos_type)
      - name: IBMCLOUD_APIKEY
        value: $(params.ibmcloud_apikey)

{% for fvt_param in fvt_params_definition.params %}
      - name: {{ fvt_param.name | upper }}
        value: $(params.{{ fvt_param.name }})
{% endfor %}

  steps:
    # It uses pipeline_name to know what pipeline to run
    - name: run-pipeline
      command:
        - /opt/app-root/src/run-pipeline.sh
      image: '$(params.fvt_image_registry)/mas-devops/ansible-fvt:latest'
      imagePullPolicy: Always
