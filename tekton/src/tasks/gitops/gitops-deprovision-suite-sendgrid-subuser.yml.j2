---
apiVersion: tekton.dev/v1beta1
kind: Task
metadata:
  name: gitops-deprovision-suite-sendgrid-subuser
spec:
  params:
    - name: cluster_name
      type: string
    - name: account
      type: string
    - name: mas_instance_id
      type: string
    - name: icn
      type: string
    - name: cis_mas_domain
      type: string
    - name: cis_crn
      type: string
  stepTemplate:
    name: gitops-deprovision-suite-sendgrid-subuser
    env:
      - name: CLUSTER_ID
        value: $(params.cluster_name)
      - name: ACCOUNT_ID
        value: $(params.account)
      - name: MAS_INSTANCE_ID
        value: $(params.mas_instance_id)

      - name: ICN
        value: $(params.icn)
      - name: CIS_MAS_DOMAIN
        value: $(params.cis_mas_domain)
      - name: CIS_CRN
        value: $(params.cis_crn)
    envFrom:
      - configMapRef:
          name: environment-properties
          optional: true
      - secretRef:
          name: secure-properties
  steps:
    - args:
      - |-

        # Teardown of smtp config in gitops-envs + AWS SM secrets is handled by gitops-deprovision-suite-smtp-config task
        # All we need to do here is make sure we clean up SendGrid and CIS

        mas-saas-sendgrid-subuser \
          --customer-id "${ICN}" \
          --mas-account-id "${ACCOUNT_ID}" \
          --mas-cluster-id "${CLUSTER_ID}" \
          --mas-instance-id "${MAS_INSTANCE_ID}" \
          --cis-crn "${CIS_CRN}" \
          --cis-mas-domain "${CIS_MAS_DOMAIN}" \
          --action delete

        exit $?
      command:
        - /bin/sh
        - -c
      name: gitops-deprovision-suite-sendgrid-subuser
      imagePullPolicy: Always
      image: docker-na-public.artifactory.swg-devops.com/wiotp-docker-local/mas/saas-task:latest
  workspaces:
    - name: configs
