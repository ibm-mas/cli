---
apiVersion: tekton.dev/v1beta1
kind: Task
metadata:
  name: mas-upgrade-run-pipeline
spec:
  params:    
    # Run Pipeline Parameters
    - name: pipelinerun_timeout
      type: string
      description: pipelinerun timeout
      default: 10h
    - name: pipelinerun_name_suffix
      description: optional suffix to pipelinerun task name
      default: ""

    # Common Parameters
    # CLI Version
    - name: cli_version
      type: string
      description: version of mas cli to be used in tasks and dependencies
      default: ""

    # Registry
    - name: fvt_image_registry
      type: string
      default: ""

    # Artifactory Secret
    - name: fvt_artifactory_username
      type: string
      default: ""
    - name: fvt_artifactory_apikey
      type: string
      default: ""

    # Persist Results (Optional)
    - name: devops_mongo_uri
      type: string
      default: ""
    - name: devops_build_number
      type: string
      default: ""
    - name: test_type
      type: string
      description: Optional. Used to different upgrade tests from other type of tests
      default: ""
    - name: test_phase
      type: string
      description: Optional. Used to categorize the phase of pipeline this test is running. Used by integrated pipelines like upgrade-test
      default: ""

    # MAS Configuration
    - name: mas_instance_id
      type: string
    - name: mas_channel
      type: string
      default: ""

    # MAS Configuration - Workspace
    - name: mas_workspace_id
      type: string
      description: Workspace ID used to configure all applications
      default: masdev

    # MAS Configuration - Application Channels
    - name: mas_app_channel_iot
      type: string
      description: Subscription channel for IoT application operator
      default: ""
    - name: mas_app_channel_manage
      type: string
      description: Subscription channel for Manage application operator
      default: ""
    - name: mas_app_channel_monitor
      type: string
      description: Subscription channel for Monitor application operator
      default: ""
    - name: mas_app_channel_optimizer
      type: string
      description: Subscription channel for Optimizer application operator
      default: ""
    - name: mas_app_channel_predict
      type: string
      description: Subscription channel for Predict application operator
      default: ""
    - name: mas_app_channel_hputilities
      type: string
      description: Subscription channel for Health & Predict - Utilities application operator
      default: ""
    - name: mas_app_channel_assist
      type: string
      description: Subscription channel for Assist application operator
      default: ""
    - name: mas_app_channel_visualinspection
      type: string
      description: Subscription channel for MVI application operator
      default: ""


    # Upgrade Parameters
    # Skip Compatiblity Check
    - name: skip_compatibility_check
      type: string
      default: "False"

  stepTemplate:
    env:
      - name: PIPELINE_NAME
        value: upgrade
      - name: PIPELINERUN_TIMEOUT
        value: $(params.pipelinerun_timeout)
      - name: PIPELINERUN_WAIT
        value: "true"
      - name: PIPELINERUN_NAME_SUFFIX
        value: $(params.pipelinerun_name_suffix)
      - name: CLI_VERSION
        value: $(params.cli_version)
      - name: FVT_IMAGE_REGISTRY
        value: $(params.fvt_image_registry)
      - name: FVT_ARTIFACTORY_USERNAME
        value: $(params.fvt_artifactory_username)
      - name: FVT_ARTIFACTORY_APIKEY
        value: $(params.fvt_artifactory_apikey)
      - name: DEVOPS_MONGO_URI
        value: $(params.devops_mongo_uri)
      - name: DEVOPS_BUILD_NUMBER
        value: $(params.devops_build_number)
      - name: TEST_TYPE
        value: $(params.test_type)
      - name: TEST_PHASE
        value: $(params.test_phase)
      - name: MAS_INSTANCE_ID
        value: $(params.mas_instance_id)
      - name: MAS_CHANNEL
        value: $(params.mas_channel)
      - name: MAS_WORKSPACE_ID
        value: $(params.mas_workspace_id)
      - name: MAS_APP_CHANNEL_IOT
        value: $(params.mas_app_channel_iot)
      - name: MAS_APP_CHANNEL_MANAGE
        value: $(params.mas_app_channel_manage)
      - name: MAS_APP_CHANNEL_MONITOR
        value: $(params.mas_app_channel_monitor)
      - name: MAS_APP_CHANNEL_OPTIMIZER
        value: $(params.mas_app_channel_optimizer)
      - name: MAS_APP_CHANNEL_PREDICT
        value: $(params.mas_app_channel_predict)
      - name: MAS_APP_CHANNEL_HPUTILITIES
        value: $(params.mas_app_channel_hputilities)
      - name: MAS_APP_CHANNEL_ASSIST
        value: $(params.mas_app_channel_assist)
      - name: MAS_APP_CHANNEL_VISUALINSPECTION
        value: $(params.mas_app_channel_visualinspection)
      - name: SKIP_COMPATIBILITY_CHECK
        value: $(params.skip_compatibility_check)

  steps:
    # It uses pipeline_name to know what pipeline to run
    - name: run-pipeline
      command:
        - /opt/app-root/src/run-pipeline.sh
      image: '$(params.fvt_image_registry)/mas-devops/mas-tekton:latest'
      imagePullPolicy: Always
