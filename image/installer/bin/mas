#!/bin/bash

# Usage: mas install

set -e

function trap_exit {
  RC=$?
  if [[ $RC != "0" ]]; then
    echo_warning "\nFatal Error[$RC]  See $DIR/mas.log for details"
  fi
  save_config
}
function trap_int {
  echo
  echo
  save_config
  exit 0
}

trap trap_exit EXIT
trap trap_int INT


DIR="$( cd "$( dirname "${BASH_SOURCE[0]}" )" && pwd )"
LOGFILE=$DIR/mas.log

. $DIR/functions/utils
. $DIR/functions/connect
. $DIR/functions/install_pipeline
. $DIR/functions/config_pipeline
. $DIR/functions/save_config
. $DIR/functions/show_config
. $DIR/functions/run_pipeline
. $DIR/functions/download_mustgather

echo "${TEXT_UNDERLINE}IBM Maximo Application Suite Installer${TEXT_RESET}"
echo "Powered by ${COLOR_CYAN}${TEXT_UNDERLINE}https://github.com/ibm-mas/ansible-devops/${TEXT_RESET} and ${COLOR_CYAN}${TEXT_UNDERLINE}https://tekton.dev/${TEXT_RESET}"
echo
echo "${TEXT_UNDERLINE}${TEXT_DIM}Current Limitations${TEXT_RESET}"
echo "${TEXT_DIM}1. The installer relies on built-in automatic storage class selection (IBMCloud ROKS & OpenShift Container Storage supported)"
echo "${TEXT_DIM}2. Installation and configuration management for Cloud Pak for Data services is not yet complete"
echo "${TEXT_DIM}3. Predict, Assist, & Visual Inspection applications can not be deployed using this installer yet"
echo
reset_colors

case $1 in
  install)
    load_config
    connect
    install_pipeline
    config_pipeline
    show_config
    run_pipeline
    ;;

  download|mustgather|download-mustgather)
    connect
    download_mustgather
    ;;

  *)
    echo "unknown parameter"
    exit 1
    ;;
esac
