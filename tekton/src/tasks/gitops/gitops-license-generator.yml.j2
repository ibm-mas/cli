---
apiVersion: tekton.dev/v1beta1
kind: Task
metadata:
  name: gitops-license-generator
spec:
  params:
    - name: cluster_name
      type: string
    - name: account
      type: string
    - name: mas_instance_id
      type: string
    - name: avp_aws_secret_region
      type: string

    - name: expiry_date
      type: string
    - name: app_points
      type: string
    - name: customer_name
      type: string
    - name: country
      type: string
    - name: sls_license_icn
      type: string
    - name: sls_subscription_id
      type: string
  stepTemplate:
    name: gitops-license-generator
    env:
      - name: CLUSTER_NAME
        value: $(params.cluster_name)
      - name: ACCOUNT
        value: $(params.account)
      - name: MAS_INSTANCE_ID
        value: $(params.mas_instance_id)
      - name: SM_AWS_REGION
        value: $(params.avp_aws_secret_region)

      - name: EXPIRY_DATE
        value: $(params.expiry_date)
      - name: APP_POINTS
        value: $(params.app_points)
      - name: CUSTOMER_NAME
        value: $(params.customer_name)
      - name: COUNTRY
        value: $(params.country)
      - name: ICN
        value: $(params.sls_license_icn)
      - name: SAAS_SUB_ID
        value: $(params.sls_subscription_id)
    envFrom:
      - configMapRef:
          name: environment-properties
          optional: true
      - secretRef:
          name: secure-properties
  steps:
    - args:
      - |-
        if [[ -z "${MAS_INSTANCE_ID}" ]]; then
          MAS_INSTANCE_ID=${SAAS_SUB_ID}
          ansible-playbook ibm.mas_saas.generate_saas_license_file || exit 1
          mas gitops-license \
            -a ${ACCOUNT} \
            -i ${ICN} \
            -s ${SAAS_SUB_ID} \
            --license-file /tmp/authorized_entitlement_saas.lic
          exit $?
        else
          ansible-playbook ibm.mas_saas.generate_saas_license_file || exit 1
          mas gitops-license \
            -a ${ACCOUNT} \
            -c ${CLUSTER_NAME} \
            -m ${MAS_INSTANCE_ID} \
            --license-file /tmp/authorized_entitlement_saas.lic
          exit $?
        fi

        exit $?
      command:
        - /bin/sh
        - -c
      name: gitops-license-generator
      imagePullPolicy: Always
      image: docker-na-public.artifactory.swg-devops.com/wiotp-docker-local/mas/saas-task:latest
