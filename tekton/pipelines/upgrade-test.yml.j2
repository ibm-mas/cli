---
apiVersion: tekton.dev/v1beta1
kind: Pipeline
metadata:
  name: mas-upgrade-test
spec:
  params:
    - name: pipelines_namespace
      type: string
      description: Namespace where pipelines are installed

    # Install & Upgrade Parameters
{% for install_param in install_params_definition.params %}
{% if install_param.name in params_source_target_list %}
    - name: source_{{ install_param.name }}
      type: {{ install_param.type }}
      description: {{ install_param.description | default('\"\"', true) }}
{% if "default" in install_param %}
      default: {{ install_param.default | default('\"\"', true) }}
{% endif %}
    - name: target_{{ install_param.name }}
      type: {{ install_param.type }}
      description: {{ install_param.description | default('\"\"', true) }}
{% if "default" in install_param %}
      default: {{ install_param.default | default('\"\"', true) }}
{% endif %}
{% else %}
    - name: {{ install_param.name }}
      type: {{ install_param.type }}
      description: {{ install_param.description | default('\"\"', true) }}
{% if "default" in install_param %}
      default: {{ install_param.default | default('\"\"', true) }}
{% endif %}
{% endif %}
{% endfor %}

    # Test Parameters
{% for fvt_param in fvt_params_definition.params %}
    - name: {{ fvt_param.name }}
      type: {{ fvt_param.type }}
      description: {{ fvt_param.description | default('\"\"', true) }}
{% if "default" in fvt_param %}
      default: {{ fvt_param.default | default('\"\"', true) }}
{% endif %}
{% endfor %}

  tasks:
    - name: install
      params:
        # Pipeline Run Parameters
        - name: pipeline_name
          value: mas-install
        - name: pipelines_namespace
          value: $(params.pipelines_namespace)

        # Install Parameters
{% for install_param in install_params_definition.params %}
{% if install_param.name in params_source_target_list %}
        - name: {{ install_param.name }}
          value: $(params.source_{{ install_param.name }})
{% else %}
        - name: {{ install_param.name }}
          value: $(params.{{ install_param.name }})
{% endif %}
{% endfor %}
      taskRef:
        kind: Task
        name: mas-install-run-pipeline
    
    - name: test-before
      params:
        # Pipeline Run Parameters
        - name: pipeline_name
          value: mas-fvt-core
        - name: pipelines_namespace
          value: $(params.pipelines_namespace)
        - name: devops_mongo_uri
          value: $(params.devops_mongo_uri)
        - name: devops_build_number
          value: $(params.devops_build_number)
        - name: mas_instance_id
          value: $(params.mas_instance_id)
        - name: mas_channel
          value: $(params.source_mas_channel)
        - name: mas_workspace
          value: $(params.mas_workspace_id)
        # MAS Test parameters
{% for fvt_param in fvt_params_definition.params %}
        - name: {{ fvt_param.name }}
          value: $(params.{{ fvt_param.name }})
{% endfor %}
      taskRef:
        kind: Task
        name: mas-test-run-pipeline
      runAfter:
        - install
    
    - name: upgrade
      params:
        # Pipeline Run Parameters
        - name: pipeline_name
          value: mas-upgrade
        - name: pipelines_namespace
          value: $(params.pipelines_namespace)
          # MAS Upgrade parameters
{% for upgrade_param in upgrade_params_definition.params %}
{% if upgrade_param.name in params_source_target_list %}
        - name: {{ upgrade_param.name }}
          value: $(params.target_{{ upgrade_param.name }})
{% else %}
        - name: {{ upgrade_param.name }}
          value: $(params.{{ upgrade_param.name }})
{% endif %}
{% endfor %}
      taskRef:
        kind: Task
        name: mas-upgrade-run-pipeline
      runAfter:
        - test-before
    
    - name: test-after
      params:
        # Pipeline Run Parameters
        - name: pipeline_name
          value: mas-fvt-core
        - name: pipelines_namespace
          value: $(params.pipelines_namespace)
        - name: devops_mongo_uri
          value: $(params.devops_mongo_uri)
        - name: devops_build_number
          value: $(params.devops_build_number)
        - name: mas_instance_id
          value: $(params.mas_instance_id)
        - name: mas_channel
          value: $(params.target_mas_channel)
        - name: mas_workspace
          value: $(params.mas_workspace_id)
        # MAS Test parameters
{% for fvt_param in fvt_params_definition.params %}
        - name: {{ fvt_param.name }}
          value: $(params.{{ fvt_param.name }})
{% endfor %}
      taskRef:
        kind: Task
        name: mas-test-run-pipeline
      runAfter:
        - upgrade
