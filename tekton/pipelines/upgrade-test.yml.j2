---
apiVersion: tekton.dev/v1beta1
kind: Pipeline
metadata:
  name: mas-upgrade-test
spec:
  params:

    {{ lookup('template', 'pipelines/params/upgrade-test/params.yml.j2') | indent(4) }}
  
  tasks:

    # Install
    - name: install
      params:
        - name: pipelinerun_template_file_name
          value: install
        - name: fvt_image_registry
          value: $(params.fvt_image_registry)
        {{ lookup('template', 'taskdefs/run-pipeline/install.yml.j2') | indent(8) }}
      taskRef:
        kind: Task
        name: mas-install-run-pipeline
    
    # FVT
    - name: test-before
      params:
        - name: pipelinerun_template_file_name
          value: fvt
        - name: pipelinerun_name_suffix
          value: before
        {{ lookup('template', 'taskdefs/run-pipeline/install.yml.j2') | indent(8) }}
        {{ lookup('template', 'taskdefs/run-pipeline/fvt.yml.j2') | indent(8) }}
      taskRef:
        kind: Task
        name: mas-fvt-run-pipeline
      runAfter:
        - install
    
    # Upgrade
    - name: upgrade
      params:
        - name: pipelinerun_template_file_name
          value: upgrade
        - name: fvt_image_registry
          value: $(params.fvt_image_registry)
        {{ lookup('template', 'taskdefs/run-pipeline/upgrade.yml.j2') | indent(8) }}
      taskRef:
        kind: Task
        name: mas-upgrade-run-pipeline
      runAfter:
        - test-before
    
    # FVT
    - name: test-after
      params:
        - name: pipelinerun_template_file_name
          value: fvt
        - name: pipelinerun_name_suffix
          value: after
        {{ lookup('template', 'taskdefs/run-pipeline/install.yml.j2') | indent(8) }}
        {{ lookup('template', 'taskdefs/run-pipeline/fvt.yml.j2') | indent(8) }}
      taskRef:
        kind: Task
        name: mas-fvt-run-pipeline
      runAfter:
        - upgrade
