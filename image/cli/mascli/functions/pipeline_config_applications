#!/bin/bash

. $DIR/functions/pipeline_config_externaldb


function channel_select_iot() {
  case $MAS_CHANNEL in
    8.9.x)
      MAS_APP_CHANNEL_IOT=8.6.x
      ;;
    8.8.x)
      MAS_APP_CHANNEL_IOT=8.5.x
      ;;
    8.7.x)
      MAS_APP_CHANNEL_IOT=8.4.x
      ;;
    *)
      prompt_for_input 'Custom Subscription Channel' MAS_APP_CHANNEL_IOT
      ;;
  esac
  true
}

function channel_select_monitor() {
  case $MAS_CHANNEL in
    8.9.x)
      MAS_APP_CHANNEL_MONITOR=8.9.x
      ;;
    8.8.x)
      MAS_APP_CHANNEL_MONITOR=8.8.x
      ;;
    8.7.x)
      MAS_APP_CHANNEL_MONITOR=8.7.x
      ;;
    *)
      prompt_for_input 'Custom Subscription Channel' MAS_APP_CHANNEL_MONITOR
      ;;
  esac
  true
}

function channel_select_manage() {
  case $MAS_CHANNEL in
    8.9.x)
      MAS_APP_CHANNEL_MANAGE=8.5.x
      ;;
    8.8.x)
      MAS_APP_CHANNEL_MANAGE=8.4.x
      ;;
    8.7.x)
      MAS_APP_CHANNEL_MANAGE=8.3.x
      ;;
    *)
      prompt_for_input 'Custom Subscription Channel' MAS_APP_CHANNEL_MANAGE
      ;;
  esac
  true
}

function channel_select_predict() {
  if [[ -z "$AIRGAP_MODE" ]]; then
    case $MAS_CHANNEL in
      8.9.x)
        MAS_APP_CHANNEL_PREDICT=8.7.x
        ;;
      8.8.x)
        MAS_APP_CHANNEL_PREDICT=8.6.x
        ;;
      8.7.x)
        MAS_APP_CHANNEL_PREDICT=8.5.x
        ;;
      *)
        prompt_for_input 'Custom Subscription Channel' MAS_APP_CHANNEL_PREDICT
        ;;
    esac
  else
    MAS_APP_CHANNEL_PREDICT=""
    echo_warning "Sorry, air gap install of this application is not supported yet"
    exit 1
  fi
  true
}

function channel_select_hputilities() {
  if [[ -z "$AIRGAP_MODE" ]]; then
    case $MAS_CHANNEL in
      8.9.x)
        MAS_APP_CHANNEL_HPUTILITIES=8.5.x
        ;;
      8.8.x)
        MAS_APP_CHANNEL_HPUTILITIES=8.4.x
        ;;
      8.7.x)
        MAS_APP_CHANNEL_HPUTILITIES=8.3.x
        ;;
      *)
        prompt_for_input 'Custom Subscription Channel' MAS_APP_CHANNEL_HPUTILITIES
        ;;
    esac
  else
    MAS_APP_CHANNEL_HPUTILITIES=""
    echo_warning "Sorry, air gap install of this application is not supported yet"
    exit 1
  fi
  true
}

function channel_select_optimizer() {
  case $MAS_CHANNEL in
    8.9.x)
      MAS_APP_CHANNEL_OPTIMIZER=8.3.x
      ;;
    8.8.x)
      MAS_APP_CHANNEL_OPTIMIZER=8.2.x
      ;;
    *)
      prompt_for_input 'Custom Subscription Channel' MAS_APP_CHANNEL_OPTIMIZER
      ;;
  esac
  true
}

function channel_select_assist() {
  if [[ -z "$AIRGAP_MODE" ]]; then
    case $MAS_CHANNEL in
      8.9.x)
        MAS_APP_CHANNEL_ASSIST=8.6.x
        ;;
      8.8.x)
        MAS_APP_CHANNEL_ASSIST=8.5.x
        ;;
      8.7.x)
        MAS_APP_CHANNEL_ASSIST=8.4.x
        ;;
      *)
        prompt_for_input 'Custom Subscription Channel' MAS_APP_CHANNEL_ASSIST
        ;;
    esac
  else
    MAS_APP_CHANNEL_ASSIST=""
    echo_warning "Sorry, air gap install of this application is not supported yet"
    exit 1
  fi
  true
}

function channel_select_visualinspection() {
  case $MAS_CHANNEL in
    8.9.x)
      MAS_APP_CHANNEL_VISUALINSPECTION=8.7.x
      ;;
    8.8.x)
      MAS_APP_CHANNEL_VISUALINSPECTION=8.6.x
      ;;
    8.7.x)
      MAS_APP_CHANNEL_VISUALINSPECTION=8.5.x
      ;;
    *)
      prompt_for_input 'Custom Subscription Channel' MAS_APP_CHANNEL_VISUALINSPECTION
      ;;
  esac
  true
}


function config_pipeline_applications() {
  echo
  echo_h2 "5. Application Selection"
  # Default all applications to "do not deploy"
  MAS_APP_CHANNEL_IOT=''
  MAS_APP_CHANNEL_MONITOR=''
  MAS_APP_CHANNEL_MANAGE=''
  MAS_APP_CHANNEL_PREDICT=''
  MAS_APP_CHANNEL_ASSIST=''
  MAS_APP_CHANNEL_HPUTILITIES=''
  MAS_APP_CHANNEL_VISUALINSPECTION=''
  MAS_APP_CHANNEL_OPTIMIZER='';        MAS_APP_PLAN_OPTIMIZER=''

  if [[ "$SNO_MODE" != "true" ]]; then
    # Applications supported in air gap and online installs
    if prompt_for_confirm "Install IoT"; then
      channel_select_iot || exit 1
    fi

    # Applications only supported in online installs
    if [[ -z "$AIRGAP_MODE" ]]; then
      # Applications that require IoT
      if [[ "$MAS_APP_CHANNEL_IOT" != '' ]]; then
        # Monitor
        if prompt_for_confirm "Install Monitor"; then
          channel_select_monitor || exit 1
        fi
      fi
    fi
  fi

  # Manage
  if prompt_for_confirm "Install Manage"; then
    channel_select_manage || exit 1
    prompt_for_confirm_default_yes "+ Create demo data" MAS_APP_SETTINGS_DEMODATA
    # JDBC Config
    if prompt_for_confirm "+ Configure external database"; then
      CONFIGURE_EXTERNAL_DB="true"
      config_pipeline_externaldb
    else
      CONFIGURE_EXTERNAL_DB="false"
    fi
  fi

  if [[ "$SNO_MODE" != "true" ]]; then
    # Optimizer can only be installed from 8.8 on
    if [[ "$MAS_CHANNEL" != "8.7.x" ]]; then
      if prompt_for_confirm "Install Optimizer"; then
        channel_select_optimizer || exit 1
        # Optimizer install Plan + Validation
        while : ; do
          prompt_for_input '+ Plan [full/limited]' MAS_APP_PLAN_OPTIMIZER "full"
          [[ "$MAS_APP_PLAN_OPTIMIZER" != "full" && "$MAS_APP_PLAN_OPTIMIZER" != "limited" ]] || break
        done
      fi
    fi

    # Maximo Visual Inspection
    if prompt_for_confirm "Install Visual Inspection"; then
     channel_select_visualinspection || exit 1
    fi

    # Applications only supported in online installs
    if [[ -z "$AIRGAP_MODE" ]]; then
      # Applications that require Manage
      # TODO: these applications require Health component specifically,
      # need to review this code when add-ons selection are in place
      if [[ "$MAS_APP_CHANNEL_MANAGE" != '' ]]; then
        # Predict
        if prompt_for_confirm "Install Predict"; then
          channel_select_predict || exit 1
        fi
        # Health & Predict Utilities
        if prompt_for_confirm "Install Health & Predict - Utilities"; then
          channel_select_hputilities || exit 1
        fi
      fi

      # Assist
      if prompt_for_confirm "Install Assist"; then
        channel_select_assist || exit 1
      fi
    fi

    # Assist Dependencies
    if [[ "$MAS_APP_CHANNEL_ASSIST" != '' ]]; then
      while : ; do
        prompt_for_input 'COS Provider [ibm/ocs]' COS_TYPE "ibm"
        [[ "$COS_TYPE" != "ibm" && "$COS_TYPE" != "ocs" ]] || break
      done
      prompt_for_input "IBM Cloud API Key" IBMCLOUD_APIKEY $IBMCLOUD_APIKEY
      prompt_for_input "IBM Cloud Resource Group" IBMCLOUD_RESOURCEGROUP $IBMCLOUD_RESOURCEGROUP "Default"
    fi

    if [[ "$MAS_APP_CHANNEL_PREDICT" != "" || "$MAS_APP_CHANNEL_HPUTILITIES" != "" || "$MAS_APP_CHANNEL_ASSIST" != "" ]]; then
      case $MAS_CHANNEL in
        8.9.x)
          CP4D_VERSION=4.5.0
          ;;
        8.8.x)
          CP4D_VERSION=4.0.9
          ;;
        8.7.x)
          # Predict 8.5 was tested on 4.0.6 and 4.0.7
          # Breaking changes introduced in CP4D v4.0.8 prevent use of a newer version of CP4D
          CP4D_VERSION=4.0.7
          ;;
        *)
          echo
          echo "One or more selected applications require Cloud Pak for Data"
          prompt_for_input 'Cloud Pak for Data product version' CP4D_VERSION "4.5.0"
          ;;
      esac
    fi
  fi
}
