---
apiVersion: tekton.dev/v1beta1
kind: PipelineRun
metadata:
  generateName: $MAS_INSTANCE_ID-install-
  labels:
    tekton.dev/pipeline: mas-install
spec:
  pipelineRef:
    name: mas-install

  serviceAccountName: pipeline
  timeout: 24h

  params:
    # Enable development catalogs
    - name: artifactory_username
      value: '$ARTIFACTORY_USERNAME'
    - name: artifactory_apikey
      value: '$ARTIFACTORY_APIKEY'

    # Storage Classes
    - name: storage_class_rwx
      value: '$STORAGE_CLASS_RWX'
    - name: storage_class_rwo
      value: '$STORAGE_CLASS_RWO'

    # DB2 Classes
    - name: db2_meta_storage_accessmode
      value: '$DB2_META_STORAGE_ACCESSMODE'
    - name: db2_backup_storage_accessmode
      value: '$DB2_BACKUP_STORAGE_ACCESSMODE'
    - name: db2_cpu_requests
      value: '$DB2_CPU_REQUESTS'
    - name: db2_cpu_limits
      value: '$DB2_CPU_LIMITS'

    # Additional Mongo DB parameters
    - name: mongodb_replicas
      value: '$MONGODB_REPLICAS'
    - name: mongodb_cpu_requests
      value: '$MONGODB_CPU_REQUESTS'

    # Dependencies - IBM Entitlement Key
    - name: ibm_entitlement_key
      value: '$IBM_ENTITLEMENT_KEY'

    # Dependencies - Common Services
    - name: common_services_catalog_source
      value: '$COMMON_SERVICES_CATALOG_SOURCE'

    # Dependencies - CP4D
    - name: cpd_product_version
      value: '$CP4D_VERSION'

    # Dependencies - SLS
    - name: sls_license_id
      value: '$SLS_LICENSE_ID'
    - name: sls_license_file
      value: '$SLS_LICENSE_FILE'
    - name: sls_catalog_source
      value: '$SLS_CATALOG_SOURCE'
    - name: sls_channel
      value: '3.x'
    - name: sls_icr_cp
      value: '$SLS_ICR_CP'
    - name: sls_icr_cpopen
      value: '$SLS_ICR_CPOPEN'
    - name: sls_entitlement_username
      value: '$SLS_ENTITLEMENT_USERNAME'
    - name: sls_entitlement_key
      value: '$SLS_ENTITLEMENT_KEY'

    # Dependencies - UDS (Required, no defaults)
    - name: uds_contact_email
      value: '$UDS_CONTACT_EMAIL'
    - name: uds_contact_firstname
      value: '$UDS_CONTACT_FIRSTNAME'
    - name: uds_contact_lastname
      value: '$UDS_CONTACT_LASTNAME'

    # Dependencies - AppConnect
    - name: appconnect_entitlement_username
      value: '$APPCONNECT_ENTITLEMENT_USERNAME'
    - name: appconnect_entitlement_key
      value: '$APPCONNECT_ENTITLEMENT_KEY'

    # Dependencies - COS
    - name: cos_type
      value: '$COS_TYPE'
    - name: ibmcloud_apikey
      value: '$IBMCLOUD_APIKEY'

    # MAS DNS Integrations - General
    - name: dns_provider
      value: '$DNS_PROVIDER'
    # MAS DNS Integrations - Cloudflare Support
    - name: cloudflare_email
      value: '$CLOUDFLARE_EMAIL'
    - name: cloudflare_apitoken
      value: '$CLOUDFLARE_APITOKEN'
    - name: cloudflare_zone
      value: '$CLOUDFLARE_ZONE'
    - name: cloudflare_subdomain
      value: '$CLOUDFLARE_SUBDOMAIN'
    # MAS DNS Integrations - CIS Support
    - name: cis_email
      value: '$CIS_EMAIL'
    - name: cis_apikey
      value: '$CIS_APIKEY'
    - name: cis_crn
      value: '$CIS_CRN'
    - name: cis_subdomain
      value: '$CIS_SUBDOMAIN'

    # Configure MAS Core install
    - name: mas_instance_id
      value: '$MAS_INSTANCE_ID'
    - name: mas_channel
      value: '$MAS_CHANNEL'
    - name: mas_catalog_source
      value: '$MAS_CATALOG_SOURCE'
    - name: mas_catalog_version
      value: '$MAS_CATALOG_VERSION'

    - name: mas_domain
      value: '$MAS_DOMAIN'
    - name: mas_cluster_issuer
      value: '$MAS_CLUSTER_ISSUER'

    - name: mas_entitlement_username
      value: '$MAS_ENTITLEMENT_USERNAME'
    - name: mas_entitlement_key
      value: '$MAS_ENTITLEMENT_KEY'
    - name: mas_annotations
      value: '$MAS_ANNOTATIONS'

    - name: mas_icr_cp
      value: '$MAS_ICR_CP'
    - name: mas_icr_cpopen
      value: '$MAS_ICR_CPOPEN'

    # Configure MAS Applications to install
    # IoT Application
    - name: mas_app_source_iot
      value: '$MAS_APP_SOURCE_IOT'
    - name: mas_app_channel_iot
      value: '$MAS_APP_CHANNEL_IOT'
    # Manage application
    - name: mas_app_source_manage
      value: '$MAS_APP_SOURCE_MANAGE'
    - name: mas_app_channel_manage
      value: '$MAS_APP_CHANNEL_MANAGE'
    - name: mas_app_settings_aio_flag
      value: '$MAS_APP_SETTINGS_AIO_FLAG'
    - name: mas_app_settings_demodata
      value: '$MAS_APP_SETTINGS_DEMODATA'
    # Monitor Application
    - name: mas_app_source_monitor
      value: '$MAS_APP_SOURCE_MONITOR'
    - name: mas_app_channel_monitor
      value: '$MAS_APP_CHANNEL_MONITOR'
    # Optimizer Application
    - name: mas_app_source_optimizer
      value: '$MAS_APP_SOURCE_OPTIMIZER'
    - name: mas_app_channel_optimizer
      value: '$MAS_APP_CHANNEL_OPTIMIZER'
    - name: mas_app_plan_optimizer
      value: '$MAS_APP_PLAN_OPTIMIZER'
    # Predict Application
    - name: mas_app_source_predict
      value: '$MAS_APP_SOURCE_PREDICT'
    - name: mas_app_channel_predict
      value: '$MAS_APP_CHANNEL_PREDICT'
    # Safety Application
    - name: mas_app_source_safety
      value: '$MAS_APP_SOURCE_SAFETY'
    - name: mas_app_channel_safety
      value: '$MAS_APP_CHANNEL_SAFETY'
    # HPUtilities Application
    - name: mas_app_source_hputilities
      value: '$MAS_APP_SOURCE_HPUTILITIES'
    - name: mas_app_channel_hputilities
      value: '$MAS_APP_CHANNEL_HPUTILITIES'
    # Assist Application
    - name: mas_app_source_assist
      value: '$MAS_APP_SOURCE_ASSIST'
    - name: mas_app_channel_assist
      value: '$MAS_APP_CHANNEL_ASSIST'
    # MVI Application
    - name: mas_app_source_visualinspection
      value: '$MAS_APP_SOURCE_VISUALINSPECTION'
    - name: mas_app_channel_visualinspection
      value: '$MAS_APP_CHANNEL_VISUALINSPECTION'

  workspaces:
    # The generated configuration files
    - name: shared-configs
      persistentVolumeClaim:
        claimName: config-pvc

    # Any pre-generated configs that will be copied into the
    # shared-config during install-suite
    - name: shared-additional-configs
      secret:
        secretName: pipeline-additional-configs

    # The SLS entitlement key file that will be installed
    # during install-sls
    - name: shared-entitlement
      secret:
        secretName: pipeline-sls-entitlement

    # The storage to hold mustgather output after the pipeline has completed
    - name: shared-mustgather
      persistentVolumeClaim:
        claimName: shared-mustgather-storage
