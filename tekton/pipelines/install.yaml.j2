---
# Don't edit install.yaml directly -- modify install.yaml.j2, and the content in parts/, then run "ansible-playbook generate-install.yaml"
apiVersion: tekton.dev/v1beta1
kind: Pipeline
metadata:
  name: mas-install
spec:
  workspaces:
    # The generated configuration files
    - name: shared-configs
    # Any pre-generated configs that will be copied into the shared-configs workspace during suite-install
    - name: shared-additional-configs
    # The SLS entitlement key file that will be installed during install-sls.
    - name: shared-entitlement
    # Shared storage to hold mustgather output for tasks
    - name: shared-mustgather

  params:
    # Development Build Support
    - name: artifactory_username
      default: ""
      type: string
      description: Required to install development MAS catalogs
    - name: artifactory_apikey
      default: ""
      type: string
      description: Required to install development MAS catalogs

    - name: storage_class_rwo
      type: string
      default: ""
      description: ReadWriteOnce storage class

    - name: storage_class_rwx
      type: string
      default: ""
      description: ReadWriteMany storage class

    - name: ibm_entitlement_key        # Required
      type: string
      description: IBM Entitlement Key

    # Dependencies - Foundation Services
    - name: common_services_catalog_source
      type: string
      default: ""

    # Dependencies - SLS
    - name: sls_license_id             # Required
      type: string
    - name: sls_license_file           # Required
      type: string
    - name: sls_mongodb_cfg_file
      type: string
      default: "/workspace/configs/mongo-mongoce.yml"
    - name: sls_catalog_source
      type: string
      default: ""
    - name: sls_channel
      type: string
      default: ""
    - name: sls_icr_cp
      type: string
      default: ""
    - name: sls_icr_cpopen
      type: string
      default: ""
    - name: sls_entitlement_username
      type: string
      default: ""
    - name: sls_entitlement_key
      type: string
      default: ""
      description: Override IBM Entitlement key for SLS installation

    # Dependencies - Mongo
    - name: mongodb_storage_class
      type: string
      default: ""

    # Dependencies - Kafka
    - name: kafka_namespace
      type: string
      default: ""
    - name: kafka_cluster_name
      type: string
      default: ""
    - name: kafka_cluster_size
      type: string
      default: ""
    - name: kafka_user_name
      type: string
      default: ""

    # Dependencies - nvidia gpu
    - name: gpu_namespace
      type: string
      description: Optional. Nvidia gpu namespace
      default: ""
    - name: gpu_channel
      type: string
      description: Optional. Nvidia gpu channel for install and updates
      default: ""
    - name: nfd_namespace
      type: string
      description: Optional. Node feature discovery namespace
      default: ""
    - name: nfd_channel
      type: string
      description: Optional. Node feature discovery channel for install and updates
      default: ""

    # Dependencies - CP4D
    - name: cpd_operators_namespace
      type: string
      default: ""
    - name: cpd_instance_namespace
      type: string
      default: ""
    - name: cpd_primary_storage_class
      type: string
      default: ""
    - name: cpd_metadata_storage_class
      type: string
      default: ""

    # Dependencies - CP4D Services
    - name: cpd_product_version        # Required
      type: string
    - name: cpd_wd_storage_class
      type: string
      default: ""
    - name: cpd_wml_storage_class
      type: string
      default: ""
    - name: cpd_spark_storage_class
      type: string
      default: ""
    - name: cpd_wsl_storage_class
      type: string
      default: ""

    # Dependencies - UDS
    - name: uds_contact_email          # Required
      type: string
    - name: uds_contact_firstname      # Required
      type: string
    - name: uds_contact_lastname       # Required
      type: string

    # Dependencies - AppConnect
    - name: appconnect_entitlement_username
      type: string
      default: ""
    - name: appconnect_entitlement_key
      type: string
      default: ""
      description: Override IBM Entitlement key for AppConnect installation

    # Dependencies - COS
    - name: cos_type
      type: string
      description: COS Provider (ibm or ocs)
    - name: ibmcloud_apikey
      type: string
      description: API Key used to create COS instance in IBM Cloud
    - name: uds_event_scheduler_frequency
      type: string
      default: ""
    - name: mas_segment_key
      type: string
      default: ""

    # MAS DNS Integrations - General
    - name: dns_provider
      type: string
      default: ""
    # MAS DNS Integrations - Cloudflare Support
    - name: cloudflare_email
      type: string
      default: ""
    - name: cloudflare_apitoken
      type: string
      default: ""
    - name: cloudflare_zone
      type: string
      default: ""
    - name: cloudflare_subdomain
      type: string
      default: ""
    # MAS DNS Integrations - IBM Cloud Internet Services Support
    - name: cis_email
      type: string
      default: ""
    - name: cis_apikey
      type: string
      default: ""
    - name: cis_crn
      type: string
      default: ""
    - name: cis_subdomain
      type: string
      default: ""

    # MAS Configuration
    - name: mas_instance_id            # Required
      type: string
    - name: mas_channel                # Required
      type: string
    - name: mas_catalog_source
      type: string
      default: ibm-operator-catalog
    - name: mas_catalog_version
      type: string
      default: v8-amd64

    - name: mas_domain
      type: string
      default: ""
    - name: mas_cluster_issuer
      type: string
      default: ""

    - name: mas_icr_cp
      type: string
      default: ""
    - name: mas_icr_cpopen
      type: string
      default: ""
    - name: mas_entitlement_username
      type: string
      default: ""
    - name: mas_annotations
      type: string
      default: ""
    - name: mas_entitlement_key
      type: string
      default: ""
      description: Override IBM Entitlement key for MAS installation

    # MAS Configuration - Workspace
    - name: mas_workspace_id
      type: string
      description: Workspace ID used to configure all applications
      default: masdev
    - name: mas_workspace_name
      type: string
      description: Workspace Name used when setting up the workspace
      default: MAS Development

    # MAS Configuration - Manage Application
    - name: mas_appws_components
      type: string
      description: Manage components to configure in the workspace
      default: "base=latest,health=latest"

    # MAS Configuration - Optimizer Application
    - name: mas_app_plan_optimizer
      type: string
      description: Configure install plan of Optimizer application (full or limited)
      default: full

    # MAS Configuration - Predict
    - name: wml_instance_id
      type: string
      description: wml instance to be configured in Predict
      default: ""
    - name: wml_url
      type: string
      description: Url to access wml services
      default: ""
    - name: wml_version
      type: string
      description: product version if cpd_product_version is not set
      default: ""
    - name: predict_deployment_size
      type: string
      description: controls the workload size of predict containers
      default: ""

    # MAS Configuration - Application Channels
    - name: mas_app_channel_iot
      type: string
      description: Subscription channel for IoT application operator
      default: ""
    - name: mas_app_channel_manage
      type: string
      description: Subscription channel for Manage application operator
      default: ""
    - name: mas_app_channel_monitor
      type: string
      description: Subscription channel for Monitor application operator
      default: ""
    - name: mas_app_channel_optimizer
      type: string
      description: Subscription channel for Optimizer application operator
      default: ""
    - name: mas_app_channel_predict
      type: string
      description: Subscription channel for Predict application operator
      default: ""
    - name: mas_app_channel_safety
      type: string
      description: Subscription channel for Safety application operator
      default: ""
    - name: mas_app_channel_hputilities
      type: string
      description: Subscription channel for Health & Predict - Utilities application operator
      default: ""
    - name: mas_app_channel_assist
      type: string
      description: Subscription channel for Assist application operator
      default: ""
    - name: mas_app_channel_visualinspection
      type: string
      description: Subscription channel for MVI application operator
      default: ""

    # MAS Configuration - Application Sources
    - name: mas_app_source_iot
      type: string
      description: Subscription source for IoT application operator
      default: ibm-operator-catalog
    - name: mas_app_source_manage
      type: string
      description: Subscription source for Manage application operator
      default: ibm-operator-catalog
    - name: mas_app_source_monitor
      type: string
      description: Subscription source for Monitor application operator
      default: ibm-operator-catalog
    - name: mas_app_source_optimizer
      type: string
      description: Subscription source for Optimizer application operator
      default: ibm-operator-catalog
    - name: mas_app_source_predict
      type: string
      description: Subscription source for Predict application operator
      default: ibm-operator-catalog
    - name: mas_app_source_safety
      type: string
      description: Subscription source for Safety application operator
      default: ibm-operator-catalog
    - name: mas_app_source_hputilities
      type: string
      description: Subscription source for Health & Predict - Utilities application operator
      default: ""
    - name: mas_app_source_assist
      type: string
      description: Subscription source for Assist application operator
      default: ""
    - name: mas_app_source_visualinspection
      type: string
      description: Subscription source for MVI application operator
      default: ""

    # Persist Results (Optional)
    - name: devops_mongo_uri
      type: string
      default: ""
    - name: devops_build_number
      type: string
      default: ""

  tasks:
    # 1. Setup the cluster-wide dependencies & configure cluster monitoring
    # -------------------------------------------------------------------------
    {{ lookup('template', 'taskdefs/cluster-setup/ibm-catalogs.yml.j2') | indent(4) }}
    {{ lookup('template', 'taskdefs/cluster-setup/common-services.yml.j2') | indent(4) }}
    {{ lookup('template', 'taskdefs/cluster-setup/cert-manager.yml.j2') | indent(4) }}
    {{ lookup('template', 'taskdefs/cluster-setup/sbo.yml.j2') | indent(4) }}
    {{ lookup('template', 'taskdefs/cluster-setup/cluster-monitoring.yml.j2') | indent(4) }}

    # 2. Install MongoDb
    # -------------------------------------------------------------------------
    {{ lookup('template', 'taskdefs/dependencies/mongo.yml.j2') | indent(4) }}

    # 3. Install AMQStreams (Kafka)
    # -------------------------------------------------------------------------
    {{ lookup('template', 'taskdefs/dependencies/kafka.yml.j2') | indent(4) }}

    # 4. Install Db2
    # -------------------------------------------------------------------------
    {{ lookup('template', 'taskdefs/dependencies/db2.yml.j2') | indent(4) }}

    # 5. Install IBM SLS
    # -------------------------------------------------------------------------
    {{ lookup('template', 'taskdefs/dependencies/sls.yml.j2') | indent(4) }}

    # 6. Install UDS
    # -------------------------------------------------------------------------
    {{ lookup('template', 'taskdefs/dependencies/uds.yml.j2') | indent(4) }}

    # 7. Configure Workspace
    # -------------------------------------------------------------------------
    {{ lookup('template', 'taskdefs/core/gencfg-workspace.yml.j2') | indent(4) }}

    # 8. Install & configure IBM MAS
    # -------------------------------------------------------------------------
    # 8.1 DNS Setup
    {{ lookup('template', 'taskdefs/core/suite-dns.yml.j2') | indent(4) }}
    # 8.2 Suite Installation
    {{ lookup('template', 'taskdefs/core/suite-install.yml.j2') | indent(4) }}
    # 8.3 Suite Configuration
    {{ lookup('template', 'taskdefs/core/suite-config.yml.j2') | indent(4) }}
    # 8.4 Suite Verification
    {{ lookup('template', 'taskdefs/core/suite-verify.yml.j2') | indent(4) }}
    # 8.5 Configure Db2 in MAS
    {{ lookup('template', 'taskdefs/core/suite-config-db2.yml.j2') | indent(4) }}
    # 8.6 Configure Kafka in MAS
    {{ lookup('template', 'taskdefs/core/suite-config-kafka.yml.j2') | indent(4) }}

    # 9. Cloud Pak for Data
    # -------------------------------------------------------------------------
    # 9.1 Cloud Pak for Data Platform
    {{ lookup('template', 'taskdefs/cp4d/cp4d-platform.yml.j2') | indent(4) }}
    # 9.2 Watson Studio
    {{ lookup('template', 'taskdefs/cp4d/cp4d-wsl.yml.j2') | indent(4) }}
    # 9.3 Watson Machine Learning
    {{ lookup('template', 'taskdefs/cp4d/cp4d-wml.yml.j2') | indent(4) }}
    # 9.4 Analytics Service (Spark)
    {{ lookup('template', 'taskdefs/cp4d/cp4d-spark.yml.j2') | indent(4) }}
    # 9.5 Watson Discovery
    {{ lookup('template', 'taskdefs/cp4d/cp4d-discovery.yml.j2') | indent(4) }}

    # 10. Additional Post-CP4D Install MAS Configuration
    # -------------------------------------------------------------------------
    # 10.6 Configure Watson Studio in MAS
    {{ lookup('template', 'taskdefs/core/suite-config-wsl.yml.j2') | indent(4) }}
    # 10.7 Configure Watson Discovery in MAS
    {{ lookup('template', 'taskdefs/core/suite-config-discovery.yml.j2') | indent(4) }}

    # 11. Cloud Object Storage (COS)
    # -------------------------------------------------------------------------
    # 11.1 Install COS
    {{ lookup('template', 'taskdefs/dependencies/cos.yml.j2') | indent(4) }}
    # 11.2 Configure COS in MAS
    {{ lookup('template', 'taskdefs/core/suite-config-cos.yml.j2') | indent(4) }}

    # 12. AppConnect
    # -------------------------------------------------------------------------
    # 12.1 Install AppConnect
    {{ lookup('template', 'taskdefs/dependencies/appconnect.yml.j2') | indent(4) }}
    # 12.2 Configure AppConnect in MAS
    {{ lookup('template', 'taskdefs/core/suite-config-appconnect.yml.j2') | indent(4) }}

    # You can see what I've started to do ..
    # TODO: Finish breaking this up!
    # TODO: Integrate this into the build rather than committing the generated file to GitHub

    # 20. Nvidia GPU
    # -------------------------------------------------------------------------
    - name: nvidia-gpu
      params:
        - name: devops_suite_name
          value: dependencies-nvidia-gpu
        - name: devops_build_number
          value: $(params.devops_build_number)
        - name: devops_mongo_uri
          value: $(params.devops_mongo_uri)

        - name: mas_instance_id
          value: $(params.mas_instance_id)

        - name: gpu_namespace
          value: $(params.gpu_namespace)
        - name: gpu_channel
          value: $(params.gpu_channel)
        - name: nfd_namespace
          value: $(params.nfd_namespace)
        - name: nfd_channel
          value: $(params.nfd_channel)
      taskRef:
        kind: Task
        name: mas-devops-nvidia-gpu
      # Only needed if Visual Inspection is being installed
      when:
        - input: "$(params.mas_app_channel_visualinspection)"
          operator: notin
          values: [""]
      runAfter:
        - ibm-catalogs
      workspaces:
        - name: configs
          workspace: shared-configs

    # 21. Install IBM MAS IoT application
    # -------------------------------------------------------------------------
    # 21.1 Install IoT
    - name: app-install-iot
      params:
        - name: devops_suite_name
          value: app-iot-install
        - name: devops_build_number
          value: $(params.devops_build_number)
        - name: devops_mongo_uri
          value: $(params.devops_mongo_uri)

        - name: artifactory_username
          value: $(params.artifactory_username)
        - name: artifactory_apikey
          value: $(params.artifactory_apikey)
        - name: mas_instance_id
          value: $(params.mas_instance_id)
        - name: mas_app_id
          value: iot
        - name: mas_app_channel
          value: "$(params.mas_app_channel_iot)"
        - name: mas_app_catalog_source
          value: "$(params.mas_app_source_iot)"
        - name: mas_icr_cp
          value: $(params.mas_icr_cp)
        - name: mas_entitlement_username
          value: $(params.mas_entitlement_username)
        - name: ibm_entitlement_key
          value: $(params.ibm_entitlement_key)
        - name: mas_entitlement_key
          value: $(params.mas_entitlement_key)

      taskRef:
        name: mas-devops-suite-app-install
        kind: Task
      # Only install IoT if a channel has been chosen
      when:
        - input: "$(params.mas_app_channel_iot)"
          operator: notin
          values: [""]
      runAfter:
        - suite-config-db2
        - suite-config-kafka

    # 21.2 Configure IoT workspace
    - name: app-cfg-iot
      params:
        - name: devops_suite_name
          value: app-iot-cfg
        - name: devops_build_number
          value: $(params.devops_build_number)
        - name: devops_mongo_uri
          value: $(params.devops_mongo_uri)

        - name: mas_instance_id
          value: $(params.mas_instance_id)
        - name: mas_app_id
          value: iot
        - name: mas_workspace_id
          value: "$(params.mas_workspace_id)"
      taskRef:
        name: mas-devops-suite-app-config
        kind: Task
      # Only configure a workspace for IoT if a channel has been chosen
      when:
        - input: "$(params.mas_app_channel_iot)"
          operator: notin
          values: [""]
      runAfter:
        - app-install-iot
      workspaces:
        - name: configs
          workspace: shared-configs


    # 22. Install IBM MAS Monitor application
    # -------------------------------------------------------------------------
    # 22.1 Install Monitor
    - name: app-install-monitor
      params:
        - name: devops_suite_name
          value: app-monitor-install
        - name: devops_build_number
          value: $(params.devops_build_number)
        - name: devops_mongo_uri
          value: $(params.devops_mongo_uri)

        - name: artifactory_username
          value: $(params.artifactory_username)
        - name: artifactory_apikey
          value: $(params.artifactory_apikey)
        - name: mas_instance_id
          value: $(params.mas_instance_id)
        - name: mas_app_id
          value: monitor
        - name: mas_app_channel
          value: "$(params.mas_app_channel_monitor)"
        - name: mas_app_catalog_source
          value: "$(params.mas_app_source_monitor)"
        - name: mas_icr_cp
          value: $(params.mas_icr_cp)
        - name: mas_entitlement_username
          value: $(params.mas_entitlement_username)
        - name: ibm_entitlement_key
          value: $(params.ibm_entitlement_key)
        - name: mas_entitlement_key
          value: $(params.mas_entitlement_key)

      taskRef:
        name: mas-devops-suite-app-install
        kind: Task
      # Only install Monitor if a channel has been chosen
      when:
        - input: "$(params.mas_app_channel_monitor)"
          operator: notin
          values: [""]
      runAfter:
        - app-cfg-iot

    # 22.2 Configure Monitor workspace
    - name: app-cfg-monitor
      params:
        - name: devops_suite_name
          value: app-monitor-cfg
        - name: devops_build_number
          value: $(params.devops_build_number)
        - name: devops_mongo_uri
          value: $(params.devops_mongo_uri)

        - name: mas_instance_id
          value: $(params.mas_instance_id)
        - name: mas_app_id
          value: monitor
        - name: mas_workspace_id
          value: "$(params.mas_workspace_id)"
      taskRef:
        name: mas-devops-suite-app-config
        kind: Task
      # Only configure a workspace for Monitor if a channel has been chosen
      when:
        - input: "$(params.mas_app_channel_monitor)"
          operator: notin
          values: [""]
      runAfter:
        - app-install-monitor
      workspaces:
        - name: configs
          workspace: shared-configs


    # 23. Install IBM MAS Safety application
    # -------------------------------------------------------------------------
    # 23.1 Install Safety
    - name: app-install-safety
      params:
        - name: devops_suite_name
          value: app-safety-install
        - name: devops_build_number
          value: $(params.devops_build_number)
        - name: devops_mongo_uri
          value: $(params.devops_mongo_uri)

        - name: mas_instance_id
          value: $(params.mas_instance_id)
        - name: mas_app_id
          value: safety
        - name: artifactory_username
          value: $(params.artifactory_username)
        - name: artifactory_apikey
          value: $(params.artifactory_apikey)
        - name: mas_app_channel
          value: "$(params.mas_app_channel_safety)"
        - name: mas_app_catalog_source
          value: "$(params.mas_app_source_safety)"
        - name: mas_icr_cp
          value: $(params.mas_icr_cp)
        - name: mas_entitlement_username
          value: $(params.mas_entitlement_username)
        - name: ibm_entitlement_key
          value: $(params.ibm_entitlement_key)
        - name: mas_entitlement_key
          value: $(params.mas_entitlement_key)
      taskRef:
        name: mas-devops-suite-app-install
        kind: Task
      # Only install Safety if a channel has been chosen
      when:
        - input: "$(params.mas_app_channel_safety)"
          operator: notin
          values: [""]
      runAfter:
        - app-cfg-iot

    # 23.2 Configure Safety workspace
    - name: app-cfg-safety
      params:
        - name: devops_suite_name
          value: app-safety-cfg
        - name: devops_build_number
          value: $(params.devops_build_number)
        - name: devops_mongo_uri
          value: $(params.devops_mongo_uri)

        - name: mas_instance_id
          value: $(params.mas_instance_id)
        - name: mas_app_id
          value: safety
        - name: mas_workspace_id
          value: "$(params.mas_workspace_id)"
      taskRef:
        name: mas-devops-suite-app-config
        kind: Task
      # Only install Safety if a channel has been chosen
      when:
        - input: "$(params.mas_app_channel_safety)"
          operator: notin
          values: [""]
      runAfter:
        - app-install-safety
      workspaces:
        - name: configs
          workspace: shared-configs


    # 24. Install IBM MAS Manage application
    # -------------------------------------------------------------------------
    # 24.1. Prepare database to Maxinst
    - name: suite-db2-setup-for-manage
      params:
        - name: mas_instance_id
          value: $(params.mas_instance_id)
        - name: devops_suite_name
          value: suite-db2-setup-for-manage
        - name: devops_build_number
          value: $(params.devops_build_number)
        - name: devops_mongo_uri
          value: $(params.devops_mongo_uri)

        - name: db2_instance_name
          value: "db2u-shared"
      # Only perform the hack if Manage is being installed
      when:
        - input: "$(params.mas_app_channel_manage)"
          operator: notin
          values: [""]
      taskRef:
        name: mas-devops-suite-db2-setup-for-manage
        kind: Task
      runAfter:
        - suite-config-db2

    # 24.2 Manage Install
    - name: app-install-manage
      params:
        - name: devops_suite_name
          value: app-manage-install
        - name: devops_build_number
          value: $(params.devops_build_number)
        - name: devops_mongo_uri
          value: $(params.devops_mongo_uri)

        - name: mas_instance_id
          value: $(params.mas_instance_id)
        - name: mas_app_id
          value: manage
        - name: artifactory_username
          value: $(params.artifactory_username)
        - name: artifactory_apikey
          value: $(params.artifactory_apikey)
        - name: mas_app_channel
          value: "$(params.mas_app_channel_manage)"
        - name: mas_app_catalog_source
          value: "$(params.mas_app_source_manage)"
        - name: mas_icr_cp
          value: $(params.mas_icr_cp)
        - name: mas_entitlement_username
          value: $(params.mas_entitlement_username)
        - name: ibm_entitlement_key
          value: $(params.ibm_entitlement_key)
        - name: mas_entitlement_key
          value: $(params.mas_entitlement_key)
      taskRef:
        name: mas-devops-suite-app-install
        kind: Task
      # Only install Manage if a channel has been chosen
      when:
        - input: "$(params.mas_app_channel_manage)"
          operator: notin
          values: [""]
      runAfter:
        - suite-db2-setup-for-manage

    # 24.3 Configure Manage workspace
    - name: app-cfg-manage
      params:
        - name: devops_suite_name
          value: app-manage-cfg
        - name: devops_build_number
          value: $(params.devops_build_number)
        - name: devops_mongo_uri
          value: $(params.devops_mongo_uri)

        - name: mas_instance_id
          value: $(params.mas_instance_id)
        - name: mas_app_id
          value: manage
        - name: mas_workspace_id
          value: "$(params.mas_workspace_id)"
        - name: mas_appws_components
          value: "$(params.mas_appws_components)"
      taskRef:
        name: mas-devops-suite-app-config
        kind: Task
      # Only install Manage if a channel has been chosen
      when:
        - input: "$(params.mas_app_channel_manage)"
          operator: notin
          values: [""]
      runAfter:
        - app-install-manage
      workspaces:
        - name: configs
          workspace: shared-configs


    # 25. Predict
    # -------------------------------------------------------------------------
    # 25.1 Predict Install
    - name: app-install-predict
      params:
        - name: devops_suite_name
          value: app-predict-install
        - name: devops_build_number
          value: $(params.devops_build_number)
        - name: devops_mongo_uri
          value: $(params.devops_mongo_uri)

        - name: mas_instance_id
          value: $(params.mas_instance_id)
        - name: mas_app_id
          value: predict
        - name: artifactory_username
          value: $(params.artifactory_username)
        - name: artifactory_apikey
          value: $(params.artifactory_apikey)
        - name: mas_app_channel
          value: "$(params.mas_app_channel_predict)"
        - name: mas_app_catalog_source
          value: "$(params.mas_app_source_predict)"
        - name: mas_icr_cp
          value: $(params.mas_icr_cp)
        - name: mas_entitlement_username
          value: $(params.mas_entitlement_username)
        - name: ibm_entitlement_key
          value: $(params.ibm_entitlement_key)
        - name: mas_entitlement_key
          value: $(params.mas_entitlement_key)
      taskRef:
        name: mas-devops-suite-app-install
        kind: Task
      # Only install Predict if a channel has been chosen
      when:
        - input: "$(params.mas_app_channel_predict)"
          operator: notin
          values: [""]
      runAfter:
        - app-cfg-manage
        - app-cfg-monitor
        - suite-config-watson-studio
        - watson-machine-learning
        - analytics-service


    # 25.2 Configure Predict workspace
    - name: app-cfg-predict
      params:
        - name: devops_suite_name
          value: app-predict-cfg
        - name: devops_build_number
          value: $(params.devops_build_number)
        - name: devops_mongo_uri
          value: $(params.devops_mongo_uri)

        - name: mas_instance_id
          value: $(params.mas_instance_id)
        - name: mas_app_id
          value: predict
        - name: mas_workspace_id
          value: "$(params.mas_workspace_id)"
        - name: wml_instance_id
          value: "$(params.wml_instance_id)"
        - name: wml_url
          value: "$(params.wml_url)"
        - name: wml_version
          value: "$(params.wml_version)"
        - name: cpd_product_version
          value: "$(params.cpd_product_version)"
        - name: predict_deployment_size
          value: "$(params.predict_deployment_size)"
      taskRef:
        name: mas-devops-suite-app-config
        kind: Task
      # Only install Predict if a channel has been chosen
      when:
        - input: "$(params.mas_app_channel_predict)"
          operator: notin
          values: [""]
      runAfter:
        - app-install-predict
      workspaces:
        - name: configs
          workspace: shared-configs


    # 26. Optimizer
    # -------------------------------------------------------------------------
    # 26.1 Optimizer Install
    - name: app-install-optimizer
      params:
        - name: devops_suite_name
          value: app-optimizer-install
        - name: devops_build_number
          value: $(params.devops_build_number)
        - name: devops_mongo_uri
          value: $(params.devops_mongo_uri)

        - name: mas_instance_id
          value: $(params.mas_instance_id)
        - name: mas_app_id
          value: optimizer
        - name: artifactory_username
          value: $(params.artifactory_username)
        - name: artifactory_apikey
          value: $(params.artifactory_apikey)
        - name: mas_app_channel
          value: "$(params.mas_app_channel_optimizer)"
        - name: mas_app_catalog_source
          value: "$(params.mas_app_source_optimizer)"
        - name: mas_app_plan
          value: "$(params.mas_app_plan_optimizer)"
        - name: mas_icr_cp
          value: $(params.mas_icr_cp)
        - name: mas_entitlement_username
          value: $(params.mas_entitlement_username)
        - name: ibm_entitlement_key
          value: $(params.ibm_entitlement_key)
        - name: mas_entitlement_key
          value: $(params.mas_entitlement_key)
      taskRef:
        name: mas-devops-suite-app-install
        kind: Task
      # Only install Optimizer if a channel has been chosen
      when:
        - input: "$(params.mas_app_channel_optimizer)"
          operator: notin
          values: [""]
      runAfter:
        - suite-verify

    # 26.2 Configure Optimizer workspace
    - name: app-cfg-optimizer
      params:
        - name: devops_suite_name
          value: app-optimizer-cfg
        - name: devops_build_number
          value: $(params.devops_build_number)
        - name: devops_mongo_uri
          value: $(params.devops_mongo_uri)

        - name: mas_instance_id
          value: $(params.mas_instance_id)
        - name: mas_app_id
          value: optimizer
        - name: mas_workspace_id
          value: "$(params.mas_workspace_id)"

      taskRef:
        name: mas-devops-suite-app-config
        kind: Task
      # Only install Optimizer if a channel has been chosen
      when:
        - input: "$(params.mas_app_channel_optimizer)"
          operator: notin
          values: [""]
      runAfter:
        - app-install-optimizer
      workspaces:
        - name: configs
          workspace: shared-configs


    # 27. Health & Predict - Utilities
    # -------------------------------------------------------------------------
    # 27.1 HPUtilities Install
    - name: app-install-hputilities
      params:
        - name: devops_suite_name
          value: app-hputilities-install
        - name: devops_build_number
          value: $(params.devops_build_number)
        - name: devops_mongo_uri
          value: $(params.devops_mongo_uri)

        - name: mas_instance_id
          value: $(params.mas_instance_id)
        - name: mas_app_id
          value: hputilities
        - name: artifactory_username
          value: $(params.artifactory_username)
        - name: artifactory_apikey
          value: $(params.artifactory_apikey)
        - name: mas_app_channel
          value: "$(params.mas_app_channel_hputilities)"
        - name: mas_app_catalog_source
          value: "$(params.mas_app_source_hputilities)"
        - name: mas_icr_cp
          value: $(params.mas_icr_cp)
        - name: mas_entitlement_username
          value: $(params.mas_entitlement_username)
        - name: ibm_entitlement_key
          value: $(params.ibm_entitlement_key)
        - name: mas_entitlement_key
          value: $(params.mas_entitlement_key)
      taskRef:
        name: mas-devops-suite-app-install
        kind: Task
      # Only install HPUtilities if a channel has been chosen
      when:
        - input: "$(params.mas_app_channel_hputilities)"
          operator: notin
          values: [""]
      runAfter:
        - app-cfg-manage # Requires Health as an add-on
        - suite-config-watson-studio
        - suite-config-appconnect

    # 27.2 Configure HPUtilities workspace
    - name: app-cfg-hputilities
      params:
        - name: devops_suite_name
          value: app-hputilities-cfg
        - name: devops_build_number
          value: $(params.devops_build_number)
        - name: devops_mongo_uri
          value: $(params.devops_mongo_uri)

        - name: mas_instance_id
          value: $(params.mas_instance_id)
        - name: mas_app_id
          value: hputilities
        - name: mas_workspace_id
          value: "$(params.mas_workspace_id)"
      taskRef:
        name: mas-devops-suite-app-config
        kind: Task
      # Only install HPUtilities if a channel has been chosen
      when:
        - input: "$(params.mas_app_channel_hputilities)"
          operator: notin
          values: [""]
      runAfter:
        - app-install-hputilities
      workspaces:
        - name: configs
          workspace: shared-configs


    # 28. Assist
    # -------------------------------------------------------------------------
    # 28.1 Assist Install
    - name: app-install-assist
      params:
        - name: devops_suite_name
          value: app-assist-install
        - name: devops_build_number
          value: $(params.devops_build_number)
        - name: devops_mongo_uri
          value: $(params.devops_mongo_uri)

        - name: mas_instance_id
          value: $(params.mas_instance_id)
        - name: mas_app_id
          value: assist
        - name: artifactory_username
          value: $(params.artifactory_username)
        - name: artifactory_apikey
          value: $(params.artifactory_apikey)
        - name: mas_app_channel
          value: "$(params.mas_app_channel_assist)"
        - name: mas_app_catalog_source
          value: "$(params.mas_app_source_assist)"
        - name: mas_icr_cp
          value: $(params.mas_icr_cp)
        - name: mas_entitlement_username
          value: $(params.mas_entitlement_username)
        - name: ibm_entitlement_key
          value: $(params.ibm_entitlement_key)
        - name: mas_entitlement_key
          value: $(params.mas_entitlement_key)
      taskRef:
        name: mas-devops-suite-app-install
        kind: Task
      # Only install Assist if a channel has been chosen
      when:
        - input: "$(params.mas_app_channel_assist)"
          operator: notin
          values: [""]
      runAfter:
        - suite-config-cos

    # 28.2 Configure Assist workspace
    - name: app-cfg-assist
      params:
        - name: devops_suite_name
          value: app-assist-cfg
        - name: devops_build_number
          value: $(params.devops_build_number)
        - name: devops_mongo_uri
          value: $(params.devops_mongo_uri)

        - name: mas_instance_id
          value: $(params.mas_instance_id)
        - name: mas_app_id
          value: assist
        - name: mas_workspace_id
          value: "$(params.mas_workspace_id)"
      taskRef:
        name: mas-devops-suite-app-config
        kind: Task
      # Only install Assist if a channel has been chosen
      when:
        - input: "$(params.mas_app_channel_assist)"
          operator: notin
          values: [""]
      runAfter:
        - suite-config-discovery
      workspaces:
        - name: configs
          workspace: shared-configs


    # 29. Maximo Visual Inspection (MVI)
    # -------------------------------------------------------------------------
    # 29.1 MVI Install
    - name: app-install-visualinspection
      params:
        - name: devops_suite_name
          value: app-visualinspection-install
        - name: devops_build_number
          value: $(params.devops_build_number)
        - name: devops_mongo_uri
          value: $(params.devops_mongo_uri)

        - name: mas_instance_id
          value: $(params.mas_instance_id)
        - name: mas_app_id
          value: visualinspection
        - name: artifactory_username
          value: $(params.artifactory_username)
        - name: artifactory_apikey
          value: $(params.artifactory_apikey)
        - name: mas_app_channel
          value: "$(params.mas_app_channel_visualinspection)"
        - name: mas_app_catalog_source
          value: "$(params.mas_app_source_visualinspection)"
        - name: mas_icr_cp
          value: $(params.mas_icr_cp)
        - name: mas_entitlement_username
          value: $(params.mas_entitlement_username)
        - name: ibm_entitlement_key
          value: $(params.ibm_entitlement_key)
        - name: mas_entitlement_key
          value: $(params.mas_entitlement_key)
      taskRef:
        name: mas-devops-suite-app-install
        kind: Task
      # Only install MVI if a channel has been chosen
      when:
        - input: "$(params.mas_app_channel_visualinspection)"
          operator: notin
          values: [""]
      runAfter:
        - nvidia-gpu
        - suite-verify

    # 29.2 Configure MVI workspace
    - name: app-cfg-visualinspection
      params:
        - name: devops_suite_name
          value: app-visualinspection-cfg
        - name: devops_build_number
          value: $(params.devops_build_number)
        - name: devops_mongo_uri
          value: $(params.devops_mongo_uri)

        - name: mas_instance_id
          value: $(params.mas_instance_id)
        - name: mas_app_id
          value: visualinspection
        - name: mas_workspace_id
          value: "$(params.mas_workspace_id)"
      taskRef:
        name: mas-devops-suite-app-config
        kind: Task
      # Only install MVI if a channel has been chosen
      when:
        - input: "$(params.mas_app_channel_visualinspection)"
          operator: notin
          values: [""]
      runAfter:
        - app-install-visualinspection
      workspaces:
        - name: configs
          workspace: shared-configs


  # Mustgather executed in finally block. Use suite_mustgather_download
  # playbook to retrieve the output on your local machine
  # -------------------------------------------------------------------------
  finally:
    - name: suite-mustgather
      params:
        - name: base_output_dir
          value: "/workspace/mustgather/$(context.pipelineRun.name)"
        - name: mas_instance_id
          value: $(params.mas_instance_id)
      taskRef:
        kind: Task
        name: mas-devops-suite-mustgather
      workspaces:
        - name: mustgather
          workspace: shared-mustgather
