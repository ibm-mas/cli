apiVersion: argoproj.io/v1alpha1
kind: Application
metadata:
  name: mas-{{ MAS_INSTANCE_ID }}-db2
  namespace: openshift-gitops
  finalizers:
    - resources-finalizer.argocd.argoproj.io
spec:
  destination:
    namespace: {{DB2_NAMESPACE}}
    server: 'https://kubernetes.default.svc'
  project: {{ MAS_INSTANCE_ID }}
  source:
    path: applications/ibm-db2u
    plugin:
      env:
        - name: HELM_VALUES
          value: |
            db2_namespace: {{DB2_NAMESPACE}}
            db2_channel: {{DB2_CHANNEL}}
            db2_instance_name: {{DB2_INSTANCE_NAME}}
            db2_dbname: {{DB2_DBNAME}}
            db2_version: {{DB2_VERSION}}
            db2_jdbc_username: db2inst1
            db2_table_org: {{DB2_TABLE_ORG}}
            db2_node_label: {{DB2_NODE_LABEL}}
            db2_dedicated_node: {{DB2_DEDICATED_NODE}}
            db2_instance_registry:
              DB2AUTH: 'OSAUTHDB,ALLOW_LOCAL_FALLBACK,PLUGIN_AUTO_RELOAD'
              DB2_4K_DEVICE_SUPPORT: '{{ DB2_4K_DEVICE_SUPPORT }}'
              DB2_FMP_RUN_AS_CONNECTED_USER: 'NO'
              DB2_WORKLOAD: '{{ DB2_WORKLOAD }}'
            db2_database_db_config:
              APPLHEAPSZ: '8192 AUTOMATIC'
            db2_mln_count: {{DB2_MLN_COUNT}}
            db2_num_pods: {{DB2_NUM_PODS}} 
            db2_meta_storage_class: {{DB2_META_STORAGE_CLASS}}
            db2_meta_storage_size: {{DB2_META_STORAGE_SIZE}}
            db2_meta_storage_accessmode: {{DB2_META_STORAGE_ACCESSMODE}}
            db2_data_storage_class: {{DB2_DATA_STORAGE_CLASS}}
            db2_data_storage_size: {{DB2_DATA_STORAGE_SIZE}}
            db2_data_storage_accessmode: {{DB2_DATA_STORAGE_ACCESSMODE}}
            db2_backup_storage_class: {{DB2_BACKUP_STORAGE_CLASS}}
            db2_backup_storage_size: {{DB2_BACKUP_STORAGE_SIZE}}
            db2_backup_storage_accessmode: {{DB2_BACKUP_STORAGE_ACCESSMODE}}
            db2_logs_storage_class: {{DB2_LOGS_STORAGE_CLASS}}
            db2_logs_storage_size: {{DB2_LOGS_STORAGE_SIZE}}
            db2_logs_storage_accessmode: {{DB2_LOGS_STORAGE_ACCESSMODE}}
            db2_temp_storage_class: {{DB2_TEMP_STORAGE_CLASS}}
            db2_temp_storage_size: {{DB2_TEMP_STORAGE_SIZE}}
            db2_temp_storage_accessmode: {{DB2_TEMP_STORAGE_ACCESSMODE}}
            db2_ldap_username: {{DB2_LDAP_USERNAME}}
            db2_ldap_password: {{DB2_LDAP_PASSWORD}}
            db2_rotate_password: {{DB2_LDAP_ROTATE_PASSWORD}}
            mas_instance_id: {{MAS_INSTANCE_ID}}
            mas_config_dir: {{MAS_CONFIG_DIR}}
            mas_config_scope: {{MAS_CONFIG_SCOPE}}
            mas_workspace_id: {{MAS_WORKSPACE_ID}}
            mas_application_id: {{MAS_APP_ID}}
            db2_cpu_requests: {{DB2_CPU_REQUESTS}}
            db2_cpu_limits: {{DB2_CPU_LIMITS}}
            db2_memory_requests: {{DB2_MEMORY_REQUESTS}}
            db2_memory_limits: {{DB2_MEMORY_LIMITS}}
            registry: cp.icr.io
            registry_user: cp
            ibm_entitlement_key: <path:{{ SECRETS_PATH }}:{{ SECRET_KEY_IBM_ENTITLEMENT }}>
            db2_entitlement_key: <path:{{ SECRETS_PATH }}:{{ SECRET_KEY_IBM_ENTITLEMENT }}>
            custom_labels: {{CUSTOM_LABELS}}
            cluster_domain: {{CLUSTER_DOMAIN}}
    repoURL: 'https://github.com/ibm-mas/gitops'
    targetRevision: {{ GITOPS_VERSION }}
  syncPolicy:
    automated:
      prune: true
      selfHeal: true
    syncOptions:
      - CreateNamespace=false
    managedNamespaceMetadata:
      labels:
        argocd.argoproj.io/managed-by: openshift-gitops
