- hosts: localhost
  any_errors_fatal: true
  vars:
    param1: UDS_CONTACT_EMAIL
    param2: UDS_CONTACT_NAME
  tasks:
    # - name: "Resolve install parameters template into a list"
    #   ansible.builtin.template:
    #     src: pipelines/params/upgrade-test/test.yml.j2
    #     dest: pipelines/params/upgrade-test/test.yml
    
    # Load Source & Target Attributes
    - name: "Load source target attributes"
      ansible.builtin.set_fact:
        params_source_target_list: "{{ params_source_target_list | default([]) + [item] }}"
      with_lines: cat pipelines/params/upgrade-test/source-target.txt

    # Load Install Parameters
    - name: "Resolve install parameters template into a list"
      ansible.builtin.template:
        src: pipelines/params/upgrade-test/install-list.yml.j2
        dest: pipelines/params/upgrade-test/install-list.yml
    - name: "Load install parameters list into a variable"
      ansible.builtin.include_vars:
        file: pipelines/params/upgrade-test/install-list.yml
        name: install_params_definition
    
    # Load FVT Parameters
    - name: "Resolve fvt parameters template into a list"
      ansible.builtin.template:
        src: pipelines/params/upgrade-test/fvt-list.yml.j2
        dest: pipelines/params/upgrade-test/fvt-list.yml
    - name: "Load fvt parameters list into a variable"
      ansible.builtin.include_vars:
        file: pipelines/params/upgrade-test/fvt-list.yml
        name: fvt_params_definition
    
    # Load Upgrade Parameters
    - name: "Resolve upgrade parameters template into a list"
      ansible.builtin.template:
        src: pipelines/params/upgrade-test/upgrade-list.yml.j2
        dest: pipelines/params/upgrade-test/upgrade-list.yml
    - name: "Load upgrade parameters list into a variable"
      ansible.builtin.include_vars:
        file: pipelines/params/upgrade-test/upgrade-list.yml
        name: upgrade_params_definition

    # Generate Run Pipeline Tasks
    - name: "Generate install-run-pipeline task"
      ansible.builtin.template:
        src: tasks/install-run-pipeline.yml.j2
        dest: tasks/install-run-pipeline.yml
    - name: "Generate fvt-run-pipeline task"
      ansible.builtin.template:
        src: tasks/fvt-run-pipeline.yml.j2
        dest: tasks/fvt-run-pipeline.yml
    - name: "Generate upgrade-run-pipeline task"
      ansible.builtin.template:
        src: tasks/upgrade-run-pipeline.yml.j2
        dest: tasks/upgrade-run-pipeline.yml

    # Debug
    - name: "Debug params_definition"
      ansible.builtin.debug:
        msg:
          - "####### params_source_target_list ........... {{ params_source_target_list }}"
          - "####### install_params_definition ........... {{ install_params_definition }}"
          - "####### fvt_params_definition ............... {{ fvt_params_definition }}"
          - "####### upgrade_params_definition ........... {{ upgrade_params_definition }}"
    
    # Create Upgrade Test Pipeline
    - name: "Generate Upgrade Test Pipeline"
      ansible.builtin.template:
        src: pipelines/upgrade-test.yml.j2
        dest: pipelines/upgrade-test.yml

    # Create PipelineRun templates
    - name: "Generate install-with-fvt PipelineRun template"
      ansible.builtin.template:
        src: pipelinerun/templates/install-with-fvt-run.yml.j2
        dest: pipelinerun/install-with-fvt.yml.j2
    - name: "Generate install PipelineRun template"
      ansible.builtin.template:
        src: pipelinerun/templates/install-run.yml.j2
        dest: pipelinerun/install.yml.j2
    - name: "Generate fvt PipelineRun template"
      ansible.builtin.template:
        src: pipelinerun/templates/fvt-run.yml.j2
        dest: pipelinerun/fvt.yml.j2
    - name: "Generate upgrade PipelineRun template"
      ansible.builtin.template:
        src: pipelinerun/templates/upgrade-run.yml.j2
        dest: pipelinerun/upgrade.yml.j2
    - name: "Generate upgrade-test PipelineRun template"
      ansible.builtin.template:
        src: pipelinerun/templates/upgrade-test-run.yml.j2
        dest: pipelinerun/upgrade-test.yml.j2

    # OLD
    # - name: "Read list of install parameters"
    #   ansible.builtin.set_fact:
    #     install_param_text_list: "{{ lookup('file', 'params/install.yml') }}"
    # - ansible.builtin.set_fact:
    #     install_param_list: "{{ install_param_text_list | dict2items }}"
    # - name: "Debug install_param_list"
    #   ansible.builtin.debug:
    #     msg: "{{ install_param_list }}"
    # - name: "Generate Upgrade Test Pipeline"
    #   ansible.builtin.template:
    #     src: upgrade-test.yml.j2
    #     dest: upgrade-test.yml
