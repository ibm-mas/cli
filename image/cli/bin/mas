#!/bin/bash

# Usage: mas install

function trap_exit {
  RC=$?
  if [[ $RC != "0" ]]; then
    echo_warning "\nFatal Error[$RC]  See $DIR/mas.log for details"
  fi
  save_config
}
function trap_int {
  echo
  echo
  save_config
  exit 0
}

function usage {
echo
echo "Available commands:"
echo "  - ${TEXT_BOLD}${COLOR_GREEN}mas install${TEXT_RESET} to launch a MAS install pipeline"
echo "  - ${TEXT_BOLD}${COLOR_GREEN}mas provision-fyre${TEXT_RESET} to provision an OCP cluster on IBM DevIT Fyre (internal)"
echo "  - ${TEXT_BOLD}${COLOR_GREEN}mas provision-roks${TEXT_RESET} to provision an OCP cluster on IBMCloud Red Hat OpenShift Service"
echo "  - ${TEXT_BOLD}${COLOR_GREEN}mas setup-registry${TEXT_RESET} to setup a private container registry on an OCP cluster"
echo "  - ${TEXT_BOLD}${COLOR_GREEN}mas mirror-images${TEXT_RESET} to mirror container images required by mas to a private registry"
echo "  - ${TEXT_BOLD}${COLOR_GREEN}mas configure-ocp-for-mirror${TEXT_RESET} to configure a cluster to use a private registry as a mirror"
echo
}

trap trap_exit EXIT
trap trap_int INT


DIR="$( cd "$( dirname "${BASH_SOURCE[0]}" )" && pwd )"
LOGFILE=$DIR/mas.log

# General purpose
. $DIR/functions/utils
# MAS provisioning support
. $DIR/functions/provision_fyre
. $DIR/functions/provision_roks
# MAS installation support
. $DIR/functions/connect
. $DIR/functions/install_pipeline
. $DIR/functions/channel_select
. $DIR/functions/config_pipeline
. $DIR/functions/save_config
. $DIR/functions/show_config
. $DIR/functions/run_pipeline
. $DIR/functions/download_mustgather
# Airgap support
. $DIR/functions/setup_mirror_registry
. $DIR/functions/mirror_to_registry
. $DIR/functions/configure_ocp_for_mirror


load_config
case $1 in
  fyre|provision-fyre)
    echo "${TEXT_UNDERLINE}IBM Maximo Application Suite Fyre Cluster Provisioner${TEXT_RESET}"
    echo "Powered by ${COLOR_CYAN}${TEXT_UNDERLINE}https://github.com/ibm-mas/ansible-devops/${TEXT_RESET}"
    echo
    echo "${TEXT_UNDERLINE}${TEXT_DIM}Current Limitations${TEXT_RESET}"
    echo "${TEXT_DIM}1. This is still a work in progress"
    echo
    reset_colors
    update_ansible_collections
    provision_fyre
    ;;

  roks|provision-roks)
    echo "${TEXT_UNDERLINE}IBM Maximo Application Suite ROKS Cluster Provisioner${TEXT_RESET}"
    echo "Powered by ${COLOR_CYAN}${TEXT_UNDERLINE}https://github.com/ibm-mas/ansible-devops/${TEXT_RESET}"
    echo
    echo "${TEXT_UNDERLINE}${TEXT_DIM}Current Limitations${TEXT_RESET}"
    echo "${TEXT_DIM}1. This is still a work in progress"
    echo
    reset_colors
    update_ansible_collections
    provision_roks
    ;;

  registry|setup-registry|setup-mirror-registry|setup-airgap-registry)
    echo "${TEXT_UNDERLINE}IBM Maximo Application Suite Air Gap Registry Setup${TEXT_RESET}"
    echo "Powered by ${COLOR_CYAN}${TEXT_UNDERLINE}https://github.com/ibm-mas/ansible-airgap/${TEXT_RESET}"
    echo
    echo "${TEXT_UNDERLINE}${TEXT_DIM}Current Limitations${TEXT_RESET}"
    echo "${TEXT_DIM}1. This is still a work in progress"
    echo
    reset_colors
    update_ansible_collections
    connect
    setup_mirror_registry
    ;;

  mirror|mirror-images|mirror-registry|mirror-to-registry)
    echo "${TEXT_UNDERLINE}IBM Maximo Application Suite Air Gap Image Mirror${TEXT_RESET}"
    echo "Powered by ${COLOR_CYAN}${TEXT_UNDERLINE}https://github.com/ibm-mas/ansible-airgap/${TEXT_RESET}"
    echo
    echo "${TEXT_UNDERLINE}${TEXT_DIM}Current Limitations${TEXT_RESET}"
    echo "${TEXT_DIM}1. This is still a work in progress"
    echo
    reset_colors
    update_ansible_collections
    mirror_to_registry
    ;;

  configure-ocp-for-mirror|configure-airgap|configure-mirror|config-airgap|config-mirror)
    echo "${TEXT_UNDERLINE}IBM Maximo Application Suite Air Gap OCP Setup${TEXT_RESET}"
    echo "Powered by ${COLOR_CYAN}${TEXT_UNDERLINE}https://github.com/ibm-mas/ansible-airgap/${TEXT_RESET}"
    echo
    echo "${TEXT_UNDERLINE}${TEXT_DIM}Current Limitations${TEXT_RESET}"
    echo "${TEXT_DIM}1. This is still a work in progress"
    echo
    reset_colors
    update_ansible_collections
    connect
    configure_ocp_for_mirror
    ;;

  install)
    echo "${TEXT_UNDERLINE}IBM Maximo Application Suite Installer${TEXT_RESET}"
    echo "Powered by ${COLOR_CYAN}${TEXT_UNDERLINE}https://github.com/ibm-mas/ansible-devops/${TEXT_RESET} and ${COLOR_CYAN}${TEXT_UNDERLINE}https://tekton.dev/${TEXT_RESET}"
    echo
    echo "${TEXT_UNDERLINE}${TEXT_DIM}Current Limitations${TEXT_RESET}"
    echo "${TEXT_DIM}1. Install relies on built-in automatic storage class selection (IBMCloud ROKS & OpenShift Container Storage supported)"
    echo "${TEXT_DIM}2. Installation and configuration management for Cloud Pak for Data services is not yet complete"
    echo "${TEXT_DIM}3. Predict, Assist, & Visual Inspection applications can not be deployed using the install yet"
    echo "${TEXT_DIM}4. Support for airgap installation is limited to MAS 8.7 (core only) at present"
    echo
    reset_colors
    connect
    install_pipeline
    config_pipeline
    show_config
    run_pipeline
    ;;

  download|mustgather|download-mustgather)
    connect
    download_mustgather
    ;;

  *)
    echo "unknown parameter"
    usage
    exit 1
    ;;
esac
