name: Tekton validation

on:
  pull_request:
    branches: [ "master" ]
    types: [ "opened", "reopened" ]
  push:
    branches: ["**"]

jobs:
  tekton-validation:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Create new PR branch
        id: branch_creation
        run: |
          set +e
          BRANCH_NAME="tekton-1760"
          git rev-parse --verify --quiet $BRANCH_NAME &>/dev/null
          if [[ $rc -ne "0" ]]; then
            git checkout -b $BRANCH_NAME
            git push origin $BRANCH_NAME
          else
            git pull
            git checkout $BRANCH_NAME
            git merge ${{ github.ref_name}}
            git push origin $BRANCH_NAME
          fi
          echo "branch_name=$BRANCH_NAME" >> "$GITHUB_ENV"

      - name: Tekton tests
        id: tekton-tests
        env:
          OCP_TOKEN: ${{ secrets.OCP_TOKEN }}
          OCP_SERVER: ${{ secrets.OCP_SERVER }}
          BRANCH_NAME: ${{ env.branch_name }}
        run: |
          set +e
          kubectl config set-cluster my-cluster --server=$OCP_SERVER
          kubectl config set-credentials my-user --token=$OCP_TOKEN
          echo "branch_name=$BRANCH_NAME"
          kubectl get namespace $BRANCH_NAME &>/dev/null
          rc=$?
          if [[ $rc -ne "O" ]]; then
            kubectl create namespace $BRANCH_NAME
          fi
          kubectl config set-context my-context --cluster=my-cluster --user=my-user --namespace=$BRANCH_NAME
          kubectl config use-context my-context
          make tekton-test &>/dev/null
          rc=$?
          if [[ $rc -ne "0" ]]; then
            exit 1
          fi