{%- if IS_EFS | lower == 'true' -%}
data "aws_subnets" "external_subnets" {
  filter {
    name   = "vpc-id"
    values = [var.vpc_id]
  }
  filter {
    name   = "cidr-block"
    values = {{CLUSTER_CIDR_WORKLOAD_EXTERNAL}}
  }
}

data "aws_subnets" "internal_subnets" {
  filter {
    name   = "vpc-id"
    values = [var.vpc_id]
  }
  filter {
    name   = "cidr-block"
    values = {{CLUSTER_CIDR_WORKLOAD_INTERNAL}}
  }
}
{%- endif %}


locals {
{%- if IS_S3 | lower == 'true' %}
{%- if S3_BUCKET_CONFIG %}
{#- Dynamic S3 configuration from s3-buckets-config.yaml -#}
{%- for component_name, component_data in S3_BUCKET_CONFIG.items() %}
  #----{{ component_name | capitalize }} S3 Configuration ({{ component_data.buckets | length }} buckets)----
  
  # IAM User ARNs for {{ component_name }}
  iam_user_arns_{{ component_name }} = {
{%- for bucket_name, bucket_config in component_data.buckets.items() %}
{%- for iam_user in bucket_config.iam_users %}
    {{ iam_user.name }} = "${var.iam_user_arn_prefix_{{ component_name }}}-{{ iam_user.name }}-{{ iam_user.access_level }}"
{%- endfor %}
{%- endfor %}
  }

  # S3 IAM Users List for {{ component_name }}
  s3_iam_users_list_{{ component_name }} = {
{%- for bucket_name, bucket_config in component_data.buckets.items() %}
{%- for iam_user in bucket_config.iam_users %}
    {{ iam_user.name }} = {
      bucket_name   = "${var.s3bucket_name_prefix_{{ component_name }}}-{{ bucket_name }}"
      iam_user_name = "${var.iam_user_name_prefix_{{ component_name }}}-{{ iam_user.name }}-{{ iam_user.access_level }}"
      access_level  = "{{ iam_user.access_level }}"
    }
{%- endfor %}
{%- endfor %}
  }

  # IAM Users by Bucket for {{ component_name }}
  iam_users_by_bucket_{{ component_name }} = {
    for bucket_name in distinct([for u in local.s3_iam_users_list_{{ component_name }} : u.bucket_name]) :
    bucket_name => [
      for u_key, u_info in local.s3_iam_users_list_{{ component_name }} :
      local.iam_user_arns_{{ component_name }}[u_key]
      if u_info.bucket_name == bucket_name
    ]
  }

  # Bucket User Names for {{ component_name }}
  bucket_user_names_{{ component_name }} = {
{%- for bucket_name, bucket_config in component_data.buckets.items() %}
{%- for iam_user in bucket_config.iam_users %}
    {{ iam_user.name }} = "${var.iam_user_name_prefix_{{ component_name }}}-{{ iam_user.name }}-{{ iam_user.access_level }}"
{%- endfor %}
{%- endfor %}
  }

  # Bucket User Name Map for {{ component_name }}
  bucket_user_name_map_{{ component_name }} = {
    for key, value in local.s3_iam_users_list_{{ component_name }} :
    key => lookup(local.bucket_user_names_{{ component_name }}, key, null)
  }

{%- endfor %}
{%- endif %}

  #----Common S3 params----
  s3_actions = {
    ro = ["s3:GetObject", "s3:ListBucket"]
    rw = ["s3:GetObject", "s3:PutObject", "s3:DeleteObject", "s3:ListBucket"]
  }

  location = var.location
{%- endif %}

  cluster = {
  {%- if IS_S3 | lower == 'true' %}
    instance = {
      name = var.instance_name
{%- if S3_BUCKET_CONFIG %}
{#- Dynamic S3 bucket definitions from s3-buckets-config.yaml -#}
{%- for component_name, component_data in S3_BUCKET_CONFIG.items() %}
      
      #----{{ component_name | capitalize }} S3 Buckets ({{ component_data.buckets | length }} buckets)----
      {{ component_name }}_s3buckets = {
{%- for bucket_name, bucket_config in component_data.buckets.items() %}
        {{ bucket_name }} = {
          name_prefix          = var.name_prefix
          create               = var.create_bucket
          name                 = "${var.s3bucket_name_prefix_{{ component_name }}}-{{ bucket_name }}"
          id                   = "${var.s3bucket_name_prefix_{{ component_name }}}-{{ bucket_name }}"
          access_level         = "{{ bucket_config.access_level }}"
          s3_bucket_arn        = "arn:aws:s3:::${var.s3bucket_name_prefix_{{ component_name }}}-{{ bucket_name }}"
          secret_suffix        = "{{ bucket_config.secret_suffix }}"
          cos_secret_format    = false
          manage_secret_format = true
          expiration           = {{ bucket_config.expiration | tojson }}
        }
{%- endfor %}
      }
{%- endfor %}
{%- endif %}
    }
    name = var.cluster_name
  {%- if IS_EFS | lower == 'true' %}
    "external_subnet_ids" : data.aws_subnets.external_subnets.ids
    "internal_subnet_ids" : data.aws_subnets.internal_subnets.ids
  {%- endif %}
  }
{%- endif %}

{%- if IS_EFS | lower == 'true' %}
  #----EFS Configuration----
  multiple-efs = {
{%- if EFS_MANAGE == "true" %}
    manage-db2 = {
      name = join("-", ["efs", var.cluster_name, var.instance_name, "manage-db2"])
      performance_mode = "{{EFS_MANAGE_DB2_PERFORMANCE_MODE}}"
      throughput_mode = "{{EFS_MANAGE_DB2_THROUGHPUT_MODE}}"
      efs_mount_count = {{EFS_MANAGE_DB2_MOUNT_COUNT}}
    }
    manage-main = {
      name = join("-", ["efs", var.cluster_name, var.instance_name, "manage-main"])
      performance_mode = "{{EFS_MANAGE_MAIN_PERFORMANCE_MODE}}"
      throughput_mode = "{{EFS_MANAGE_MAIN_THROUGHPUT_MODE}}"
      efs_mount_count = {{EFS_MANAGE_MAIN_MOUNT_COUNT}}
    }
{%- endif %}
{%- if EFS_IOT == "true" %}
    iot-db2 = {
      name = join("-", ["efs", var.cluster_name, var.instance_name, "iot-db2"])
      performance_mode = "{{EFS_IOT_DB2_PERFORMANCE_MODE}}"
      throughput_mode = "{{EFS_IOT_DB2_THROUGHPUT_MODE}}"
      efs_mount_count = {{EFS_IOT_DB2_MOUNT_COUNT}}
    }
{%- endif %}
{%- if EFS_VISUALINSPECTION == "true" %}
    visualinspection-main = {
      name = join("-", ["efs", var.cluster_name, var.instance_name, "visualinspection-main"])
      performance_mode = "{{EFS_VISUALINSPECTION_MAIN_PERFORMANCE_MODE}}"
      throughput_mode = "{{EFS_VISUALINSPECTION_MAIN_THROUGHPUT_MODE}}"
      efs_mount_count = {{EFS_VISUALINSPECTION_MAIN_MOUNT_COUNT}}
    }
{%- endif %}
{%- if EFS_FACILITIES == "true" %}
    facilities-db2 = {
      name = join("-", ["efs", var.cluster_name, var.instance_name, "facilities-db2"])
      performance_mode = "{{EFS_FACILITIES_DB2_PERFORMANCE_MODE}}"
      throughput_mode = "{{EFS_FACILITIES_DB2_THROUGHPUT_MODE}}"
      efs_mount_count = {{EFS_FACILITIES_DB2_MOUNT_COUNT}}
    }
    facilities-main = {
      name = join("-", ["efs", var.cluster_name, var.instance_name, "facilities-main"])
      performance_mode = "{{EFS_FACILITIES_MAIN_PERFORMANCE_MODE}}"
      throughput_mode = "{{EFS_FACILITIES_MAIN_THROUGHPUT_MODE}}"
      efs_mount_count = {{EFS_FACILITIES_MAIN_MOUNT_COUNT}}
    }
{%- endif %}
  }
{%- endif %}
}