#!/bin/bash

. $DIR/functions/pipeline_config_applications
. $DIR/functions/pipeline_config_dns
. $DIR/functions/pipeline_config_storage_classes

function pipeline_config() {
  echo_h2 "3. Configure Installation"

  # MAS instance ID
  if [[ ! -z "$1" ]]; then
    MAS_INSTANCE_ID=$1
  fi
  prompt_for_input "MAS Instance ID" MAS_INSTANCE_ID

  MAS_CATALOG_SOURCE=ibm-operator-catalog
  if [[ -z "$AIRGAP_MODE" ]]; then
    prompt_for_confirm "Use online catalog?" USE_ONLINE_CATALOG
    if [[ "$USE_ONLINE_CATALOG" == "true" ]]; then
      MAS_CATALOG_VERSION=v8-amd64
    else
      echo -e "${COLOR_YELLOW}Catalog Version:"
      echo "  1. v8 (2022-09-27)"
      echo "  2. v8 (2022-08-05)"
      echo "  3. v8 (2022-07-17)"
      prompt_for_input "Select Catalog Source" MAS_CATALOG_SELECTION "1"

      case $MAS_CATALOG_SELECTION in
        1|220927|2022-09-27)
          MAS_CATALOG_VERSION=v8-220927-amd64
          ;;
        2|220805|2022-08-05)
          MAS_CATALOG_VERSION=v8-220805-amd64
          ;;
        3|220717|2022-07-17)
          MAS_CATALOG_VERSION=v8-220717-amd64
          ;;
        *)
          exit 1
          ;;
      esac
    fi

    echo -e "${COLOR_YELLOW}MAS Version:"
    echo "  1. 8.8"
    echo "  2. 8.7"
    echo "  3. 8.6"
    prompt_for_input "Select Subscription Channel" MAS_CHANNEL_SELECTION "1"

    case $MAS_CHANNEL_SELECTION in
      1|8.8|8.8.x)
        MAS_CHANNEL=8.8.x
        ;;

      2|8.7|8.7.x)
        MAS_CHANNEL=8.7.x
        ;;

      3|8.6|8.6.x)
        MAS_CHANNEL=8.6.x
        ;;

      *)
        MAS_CHANNEL=$MAS_CHANNEL_SELECTION
        prompt_for_input 'Custom Catalog Source' MAS_CATALOG_SOURCE "ibm-operator-catalog"
        ;;
    esac
  else
    echo -e "${COLOR_YELLOW}MAS Version:"
    echo "  1. 8.8.1 (2022-09-27)"
    echo "  2. 8.8.0 (2022-08-05)"
    echo "  3. 8.8.0 (2022-07-17)"
    prompt_for_input "Select Catalog Source" MAS_CHANNEL_SELECTION "1"

    case $MAS_CHANNEL_SELECTION in
      1|220927|2022-09-27)
        MAS_CHANNEL=8.8.x
        MAS_CATALOG_SOURCE=ibm-operator-catalog
        MAS_CATALOG_VERSION=v8-220927-amd64
        ;;
      2|220805|2022-08-05)
        MAS_CHANNEL=8.8.x
        MAS_CATALOG_SOURCE=ibm-operator-catalog
        MAS_CATALOG_VERSION=v8-220805-amd64
        ;;
      3|220717|2022-07-17)
        MAS_CHANNEL=8.8.x
        MAS_CATALOG_SOURCE=ibm-operator-catalog
        MAS_CATALOG_VERSION=v8-220717
        # We are deliberately leaving this without the -amd64 to ensure this is not a breaking change
        # for anyone already using v8-220717
        ;;

      *)
        echo_warning "Invalid selection"
        exit 1
        ;;
    esac
  fi
  true

  config_pipeline_dns
  config_pipeline_applications
  config_pipeline_storage_classes

  echo ""
  if [[ "$DEV_MODE" == "true" && -z "$AIRGAP_MODE" ]]; then
    # Development Mode -- offer the ability to set MAS and SLS source independently
    echo_h2 "7a. Configure Artifactory"
    prompt_for_input "Artifactory Username" ARTIFACTORY_USERNAME
    prompt_for_input "Artifactory API Key" ARTIFACTORY_APIKEY

    echo
    echo_h2 "7b. Configure IBM Container Registry"
    prompt_for_input "IBM Entitlement Key" IBM_ENTITLEMENT_KEY $IBM_ENTITLEMENT_KEY

    echo
    echo_h2 "7c. Configure IBM Container Registry (MAS)"
    prompt_for_input "IBM Container Registry (cp)" MAS_ICR_CP wiotp-docker-local.artifactory.swg-devops.com override
    prompt_for_input "IBM Container Registry (cpopen)" MAS_ICR_CPOPEN wiotp-docker-local.artifactory.swg-devops.com override
    prompt_for_input "Entitlement Username" MAS_ENTITLEMENT_USERNAME $ARTIFACTORY_USERNAME override
    prompt_for_input "Entitlement Key" MAS_ENTITLEMENT_KEY $ARTIFACTORY_APIKEY override

    echo
    echo_h2 "7d. Configure IBM Container Registry (SLS)"
    prompt_for_input "IBM Container Registry (cp)" SLS_ICR_CP wiotp-docker-local.artifactory.swg-devops.com override
    prompt_for_input "IBM Container Registry (cpopen)" SLS_ICR_CPOPEN wiotp-docker-local.artifactory.swg-devops.com override
    prompt_for_input "Entitlement Username" SLS_ENTITLEMENT_USERNAME $ARTIFACTORY_USERNAME override
    prompt_for_input "Entitlement Key" SLS_ENTITLEMENT_KEY $ARTIFACTORY_APIKEY override
  else
    # Production Mode -- everything comes from the same registry (IBM container registry)
    echo_h2 "7. Configure IBM Container Registry"
    prompt_for_input "IBM Entitlement Key" IBM_ENTITLEMENT_KEY $IBM_ENTITLEMENT_KEY

    # Use defaults
    MAS_ICR_CP=cp.icr.io/cp
    MAS_ICR_CPOPEN=icr.io/cpopen
    MAS_ENTITLEMENT_USERNAME=cp
    MAS_ENTITLEMENT_KEY=$IBM_ENTITLEMENT_KEY

    SLS_ICR_CP=cp.icr.io/cp
    SLS_ICR_CPOPEN=icr.io/cpopen
    SLS_ENTITLEMENT_USERNAME=cp
    SLS_ENTITLEMENT_KEY=$IBM_ENTITLEMENT_KEY
  fi

  COMMON_SERVICES_CATALOG_SOURCE=ibm-operator-catalog
  SLS_CATALOG_SOURCE=ibm-operator-catalog

  echo
  echo_h2 "8. Configure Product License"
  prompt_for_input "License ID" SLS_LICENSE_ID
  prompt_for_input "License File" SLS_LICENSE_FILE_LOCAL
  if [[ ! -e "$SLS_LICENSE_FILE_LOCAL" ]]; then
    echo_warning "Error: File does not exist: $SLS_LICENSE_FILE_LOCAL"
    exit 1
  fi
  SLS_LICENSE_FILE="/workspace/entitlement/$(basename $SLS_LICENSE_FILE_LOCAL)"

  echo
  echo_h2 "9. Configure UDS"
  prompt_for_input "UDS Contact Email" UDS_CONTACT_EMAIL
  prompt_for_input "UDS Contact First Name" UDS_CONTACT_FIRSTNAME
  prompt_for_input "UDS Contact Last Name" UDS_CONTACT_LASTNAME

}

# adding this section for SNO mode
echo ""
if [[ "$SNO_MODE" == "true" ]]; then
  # SNO Mode -- Set environment variables MONGODB_REPLICAS=1
  echo_h2 "10. Cluster is an SNO Cluster. Setting environment variables MONGODB_REPLICAS=1, MONGODB_CPU_REQUESTS=300m and MAS_APP_SETTINGS_AIO_FLAG=false"
  export MONGODB_REPLICAS=1
  export MONGODB_CPU_REQUESTS=300m
  export MAS_APP_SETTINGS_AIO_FLAG=false
  prompt_for_confirm_default_yes "Do you want manage demodata to be loaded or not " MAS_APP_SETTINGS_DEMODATA && export MAS_APP_SETTINGS_DEMODATA
else
  echo_h2 "10. Info: SNO_MODE was not detected"
fi